
---
title: "ADC Summary Report"
output: 
  html_document:
    toc: true
    toc_depth: 3
    theme: NULL
css: custom_markdown_4.css 
---

<!--
This version of this report inputs data files that have been downloaded from
within the Lava web application

dcat file can be written out on  about line 449
dcat file for those with â‰¥ 2 cognitive evals can be written out on about line 668
date limits for enrollment reports can be changed at about 1218
-->


<center> <h5> Generation date:  `r format(Sys.time(), '%B %d, %Y')` </h5> </center>

```{r, label="r_prelim", message=FALSE, results="hide", echo=FALSE, warning=FALSE}

# setwd("/Volumes/John Deere/dan/Database/Data Extraction/enrolled_survival_07-14/")
	
	require(RMySQL)
  require(knitr)
  require(plyr)
  require(doBy)
  require(dplyr)
  require(tidyr)
  require("Gmisc")
  require("Hmisc")
  require(lattice)
  require(pander)
  require(htmlTable)

  col_names <- c("blue","green","red","purple")

  cur_yr <- as.numeric(format(as.Date(date(), format="%a %b %d %H:%M:%S %Y"), "%Y")) 
  cur_mn <- as.numeric(format(as.Date(date(), format="%a %b %d %H:%M:%S %Y"), "%m")) 
  cur_dy <- as.numeric(format(as.Date(date(), format="%a %b %d %H:%M:%S %Y"), "%d")) 

#   --------------------------------- Input Downloaded Data Files  --------------------------------
	
  dcat <- read.table("Input Files/DataCatalog_07-31-19.csv", header=TRUE, sep=",", na.strings = "")
	enr <- read.table("Input Files/CohortEnrollment_08-01-19.csv", header=TRUE, sep=",", na.strings = "") # Lava CohortEnrollment report 
  asl1 <- read.table("Input Files/AssessList_08-01-19.csv", header=TRUE, sep=",", na.strings = "")
#   hlth <- read.table("Input Files/uds_health_hx_02-07-19.csv", header=TRUE, sep=",", na.strings = "") # semicolon delimited file

  h1 <- readLines("Input Files/UdsHealthHistory_08-01-19.csv") # csv file from Lava
  h2 <- gsub('(?m),(?=[^"]*"(?:[^"\r\n]*"[^"]*")*[^"\r\n]*$)','',h1, perl=TRUE)
  # removes comma within quotes, from http://stackoverflow.com/questions/4476812/regular-expressions-how-to-replace-a-character-within-quotes
  h2 <- gsub("'","",h2, perl=TRUE) # removes apostrophe from text string
  write(h2,file="Input Files/uds_temp.csv")
  hlth <- read.table("Input Files/uds_temp.csv", header=TRUE, sep=",", na.strings = "")
#   spdna <- read.table("Input Files/serum_plasma_dna_09-28-16.csv", header=TRUE, sep=",", na.strings = "")
  
# Data files to characterize recruitment source
  
  mdemo <- read.table("Input Files/MudsDemographicReport_08-01-19.csv", header=TRUE, 
        sep=",", na.strings = "")
  udemo <- read.table("Input Files/UdsSubjectDemographics_08-01-19.csv", header=TRUE, 
        sep=",", na.strings = "")
  
  recr <- merge(udemo[,c("SubjectStudyID","ClinAssessN","DCDate","REASON")],
        mdemo[,c("SubjectStudyID","ClinAssessN","REASEVAL")],
        by=c("SubjectStudyID","ClinAssessN"),all.x=TRUE)
  recr <- recr[recr$ClinAssessN %in% 1,]
  names(recr) <- gsub("SubjectStudyID","ID",names(recr))
  names(recr) <- gsub("DCDate","RecrDate",names(recr))
  
  rm(mdemo,udemo)
  
#   --------------------------------- Input Data from MySQL Database --------------------------------
# sqlPrep <- function(file){
#   paste(scan(file, sep = "\n", what = "character"), collapse = "\n")
# }
# 
# sql_enr <- sqlPrep("./SQL Files/Enrollment.sql")
# sql_dcat <- sqlPrep("./SQL Files/ADCDataCatalog_10-06-14.sql")
# 
# # sql_enr <- "CALL enrollment"
# # sql_dcat <- "CALL adc_data_catalog"
# sql_asl <- "SELECT a.* FROM assesslist AS a"
# 
# lavaDb <- dbConnect(MySQL(), group = "ucdlava", client.flag = CLIENT_MULTI_STATEMENTS)
# res_enr <- dbSendQuery(lavaDb, sql_enr)
# enr <- fetch(res_enr, n = -1)
# dbDisconnect(lavaDb)
# 
# lavaDb <- dbConnect(MySQL(), group = "ucdlava", client.flag = CLIENT_MULTI_STATEMENTS)
# res_dcat <- dbSendQuery(lavaDb, sql_dcat)
# dcat <- fetch(res_dcat, n = -1)
# dbDisconnect(lavaDb)
# 
# lavaDb <- dbConnect(MySQL(), group = "ucdlava", client.flag = CLIENT_MULTI_STATEMENTS)
# res_asl <- dbSendQuery(lavaDb, sql_asl)
# asl1 <- fetch(res_asl, n = -1)
# dbDisconnect(lavaDb)

# ----------------------------------------------------------------------------------------------------
	
	enr$LatestDate <- as.Date(as.character(enr$LatestDate), format="%m/%d/%Y")
	enr$EnrolledDate <- as.Date(as.character(enr$EnrolledDate), format="%m/%d/%Y")
	enr$DroppedDate <- as.Date(as.character(enr$DroppedDate), format="%m/%d/%Y")
	enr$LostDate <- as.Date(as.character(enr$LostDate), format="%m/%d/%Y")
	enr$RefusedDate <- as.Date(as.character(enr$RefusedDate), format="%m/%d/%Y")
	enr$DeceasedDate <- as.Date(as.character(enr$DeceasedDate), format="%m/%d/%Y")
	
	
	if ("id" %in% colnames(dcat)){
		colnames(dcat) <- gsub("id","ID",colnames(dcat))
	}
	if ("ADC_ID" %in% colnames(dcat)){
		colnames(dcat) <- gsub("ADC_ID","ID",colnames(dcat))
	}
	
	  dcat <- dcat[!dcat$ID==999999,] # exclude 999999

	  dcat <- merge(dcat,recr[,c("ID","RecrDate","REASON","REASEVAL")], by="ID",all.x=TRUE)
	  rm(recr)
	
	dcat$DtDeath <- as.Date(as.character(dcat$DtDeath), format="%m/%d/%Y")
  dcat$DtLastEval <- as.Date(as.character(dcat$DtLastEval), format="%m/%d/%Y")
  dcat$DOB <- as.Date(as.character(dcat$DOB), format="%m/%d/%Y")
  dcat$DtIA <- as.Date(as.character(dcat$DtIA), format="%m/%d/%Y")
  dcat$DtMROA <- as.Date(as.character(dcat$DtMROA), format="%m/%d/%Y")
  dcat$DtMRADx <- as.Date(as.character(dcat$DtMRADx), format="%m/%d/%Y")
  dcat$RecrDate <- as.Date(as.character(dcat$RecrDate), format="%m/%d/%Y")
  
  dcat$age_ia <- as.numeric(format(dcat$DtIA, "%Y")) - dcat$DOBYR
	dcat$age_cur <- cur_yr - dcat$DOBYR

	
	# dcat$age_ia <- as.numeric(dcat$DtIA - dcat$DOB)/365.25
	# dcat$age_cur <- as.numeric((as.Date(date(), format="%a %b %d %H:%M:%S %Y") - as.Date(dcat$DOB))/365.25)
	
	# dcat$RecrSource <- as.character(dcat$RecrSource)
	# dcat$RecrSource <- ifelse(dcat$RecrSource %in% c("Clinic","Community"), 
	#          dcat$RecrSource,
	#      ifelse(is.na(dcat$SENAS_ID),"Clinic",
	#      ifelse(dcat$SENAS_ID<100000,"Clinic","Community")))

		dcat$RecrSource <- ifelse(!is.na(dcat$SENAS_ID),
		        ifelse(dcat$SENAS_ID<100000,"Clinic","Community"),
		    ifelse(dcat$RecrDate < "2015-01-01","Clinic",
		    ifelse(dcat$REASEVAL %in% c(4,5,6,7),"Community",
		    ifelse(dcat$REASEVAL %in% 1,"Clinic",
		    ifelse(dcat$REASEVAL %in% c(2,3),
		        ifelse(dcat$REASON %in% c(1,4),"Community",
		            ifelse(dcat$REASON %in% 2,"Clinic",NA)),
			    ifelse(is.na(dcat$REASEVAL) | dcat$REASEVAL %in% c(-6,-7,-9),
		        ifelse(dcat$REASON %in% 2,"Clinic",
		        ifelse(dcat$REASON %in% 1,"Community",
		        ifelse(dcat$REASON %in% c(4,9),NA,
		        NA))),
		    NA))))))

# table(dcat$RecrSource)
	# dcat[dcat$RecrDate < "2015-01-01","RecrDate"]
#   dcat$RecrSource <- ifelse(is.na(dcat$SENAS_ID),"Clinic",ifelse(dcat$SENAS_ID<100000,
# 		    "Clinic","Community"))
	
	dcat$Cohort <- ifelse(!is.na(dcat$C2),"C2",
	       ifelse(!is.na(dcat$ADNI) & !dcat$ADNI=="REFERRED","ADNI",
	       ifelse(!is.na(dcat$C1),"C1",
	       NA)))
# dcat$Cohort <- ifelse(!is.na(dcat$C2),ifelse(!is.na(dcat$Hillblom),"C2/Hillblom","C2"),ifels# e(!is.na(dcat$IVD),"IVD",ifelse(!is.na(dcat$Hillblom),"Hillblom",ifelse(!is.na(dcat$ADNI) & # !dcat$ADNI=="REFERRED","ADNI",ifelse(!is.na(dcat$C1),"C1",NA)))))
	dcat$synd_ia <- ifelse(dcat$SYNDRIA==2,"Normal",ifelse(dcat$SYNDRIA==3,"Normal",ifelse(dcat$SYNDRIA==6,"MCI",ifelse(dcat$SYNDRIA==5,"Demented",NA))))
	dcat$synd_mra <- ifelse(dcat$SYNDRMRA==2,"Normal",ifelse(dcat$SYNDRMRA ==3,"Normal",ifelse(dcat$SYNDRMRA ==6,"MCI",ifelse(dcat$SYNDRMRA ==5,"Demented",NA))))
#	colnames(dcat)[2] <- "ID"
	dcat$grp <- ifelse(dcat$Ethnicity==1,NA,
	             ifelse(dcat$Ethnicity==2,NA,
	             ifelse(dcat$Ethnicity==3,NA,
	             ifelse(dcat$Ethnicity==4,"African American",
	             ifelse(dcat$Ethnicity==5,NA,
	             ifelse(dcat$Ethnicity==6,"Hispanic",
	             ifelse(dcat$Ethnicity==7,"White",
	             ifelse(dcat$Ethnicity==8,NA,NA))))))))
dcat$grp2 <- ifelse(dcat$Ethnicity==1,"Other",ifelse(dcat$Ethnicity==2,"Other",ifelse(dcat$Ethnicity==3,"Other",ifelse(dcat$Ethnicity==4,"African American",ifelse(dcat$Ethnicity==5,"Other",ifelse(dcat$Ethnicity==6,"Hispanic",ifelse(dcat$Ethnicity==7,"White",ifelse(dcat$Ethnicity==8,"Other",NA))))))))
	dcat$center <- ifelse(dcat$ID>=50000,"East_Bay","Sacramento")
	
dcat$ClinDxMRA <- ifelse(dcat$ETIOLMRA %in% c(7,8,24),2,ifelse(dcat$ETIOLMRA %in% c(1,2),1,ifelse(dcat$ETIOLMRA %in% c(3,4),3,ifelse(dcat$ETIOLMRA==9,4,ifelse(dcat$ETIOLMRA==21,ifelse(dcat$MIX1MRA %in% c(1,2) & dcat$MIX2MRA %in% c(3,4),5,ifelse(dcat$MIX1MRA %in% c(3,4) & dcat$MIX2MRA %in% c(1,2),5,ifelse(dcat$MIX1MRA %in% c(7,8,24) & dcat$MIX2MRA %in% c(1,2),2,ifelse(dcat$MIX2MRA %in% c(7,8,24) & dcat$MIX1MRA %in% c(1,2),2,NA)))),NA)))))
	
dcat$ClinDxMRA2 <- ifelse(dcat$SYNDRMRA==6,6,ifelse(dcat$SYNDRMRA %in% c(2,3),7,ifelse(dcat$ETIOLMRA %in% c(7,8,24),2,ifelse(dcat$ETIOLMRA %in% c(1,2),1,ifelse(dcat$ETIOLMRA %in% c(3,4),3,ifelse(dcat$ETIOLMRA==9,4,ifelse(dcat$ETIOLMRA==21,ifelse(dcat$MIX1MRA %in% c(1,2) & dcat$MIX2MRA %in% c(3,4),5,ifelse(dcat$MIX1MRA %in% c(3,4) & dcat$MIX2MRA %in% c(1,2),5,ifelse(dcat$MIX1MRA %in% c(7,8,24) & dcat$MIX2MRA %in% c(1,2),2,ifelse(dcat$MIX2MRA %in% c(7,8,24) & dcat$MIX1MRA %in% c(1,2),2,NA)))),NA)))))))


dcat$PathDx <- ifelse(dcat$PATHDX1 %in% c("2","3","4","4a","4b","4c"),ifelse(is.na(dcat$PATHDX2) | dcat$PATHDX2 %in% c("-6","-7","-9") | dcat$PATHDX2 %in% c("2","3","4","4a","4b","4c"),1,ifelse(dcat$PATHDX2 %in% c("6","6a","6b","6c","6d"),6,ifelse(dcat$PATHDX2 %in% c("7","7a","7b","7c","7d","7e","7f"),5,9))),ifelse(dcat$PATHDX1 %in% c("6","6a","6b","6c","6d"),ifelse(is.na(dcat$PATHDX2) | dcat$PATHDX2 %in% c("-6","-7","-9") | dcat$PATHDX2 %in% c("6","6a","6b","6c","6d"),2,ifelse(dcat$PATHDX2 %in% c("2","3","4","4a","4b","4c"),6,ifelse(dcat$PATHDX2 %in% c("7","7a","7b","7c","7d","7e","7f"),7,2))),ifelse(dcat$PATHDX1 %in% c("7","7a","7b","7c","7d","7e","7f"),ifelse(is.na(dcat$PATHDX2) | dcat$PATHDX2 %in% c("-6","-7","-9") | dcat$PATHDX2 %in% c("7","7a","7b","7c","7d","7e","7f"),3,ifelse(dcat$PATHDX2 %in% c("2","3","4","4a","4b","4c"),5,ifelse(dcat$PATHDX2 %in% c("6","6a","6b","6c","6d"),7,3))),ifelse(dcat$PATHDX1 %in% c("8","9"),4,ifelse(dcat$PATHDX1 %in% c("1","1a","1b","1c"),ifelse(is.na(dcat$PATHDX2) | dcat$PATHDX2 %in% c("-6","-7","-9") | dcat$PATHDX2 %in% c("1","1a","1b","1c"),8,ifelse(dcat$PATHDX2 %in% c("2","3","4","4a","4b","4c"),9,10)),ifelse(dcat$PATHDX1 %in% c("10","10a","10b","10c") & dcat$PATHDX2 %in% c("8","9"),4,ifelse(!is.na(dcat$PATHDX1) & !dcat$PATHDX1 %in% c("-6","-7","-9"),10,NA)))))))

# serum plasma dna in data catalog, don't have to be extracted

#colnames(spdna) <- gsub("SubjectStudyID","ID",colnames(spdna))
# colnames(spdna) <- gsub("ADC_ID","ID",colnames(spdna))
#spdna$DATECOLLECTED <- as.Date(as.character(spdna$DATECOLLECTED), format="%m/%d/%Y")
# spdna$DCDate <- as.Date(as.character(spdna$DCDate), format="%m/%d/%Y")
# spdna$spddate <- as.Date(as.character(spdna$spddate), format="%m/%d/%Y")
# 
# 	  spdna <- spdna[!spdna$ID==999999,] # exclude 999999
# 
# spdcnt <- spdna %>% group_by(ID) %>%
#     summarise(
#       n_serum = sum(ifelse(SERUM > 0,1,0)),
#       n_plasma = sum(ifelse(PLASMA > 0,1,0)),
#       n_dna = sum(ifelse(DNA > 0,1,0))
#     )
# 
# dcat <- merge(dcat,spdcnt,by="ID",all.x=TRUE)
# table(dcat$n_serum)
# rm(spdcnt)

dcat$n_eval <- ifelse(dcat$NMMS <=9,dcat$NMMS, 10)
dcat$n_mri <- ifelse(dcat$n_mri <=3,dcat$n_mri, 4)
dcat$n_senas_2 <- ifelse(dcat$n_senas<=9,dcat$n_senas,10)
dcat$n_ivd_npsy_2 <- ifelse(dcat$n_ivd_npsy<=9,dcat$n_ivd_npsy,10)
# dcat$n_serum <- ifelse(is.na(dcat$n_serum),NA,
#                     ifelse(dcat$n_serum>=2,2,
#                     ifelse(dcat$n_serum==1,1,NA)))
dcat$n_serum <- ifelse(dcat$n_serum>=2,2,
                       ifelse(dcat$n_serum==1,1,NA))
dcat$n_plasma <- ifelse(dcat$n_plasma>=2,2,
                       ifelse(dcat$n_plasma==1,1,NA))
dcat$n_dna <- ifelse(dcat$n_dna>=2,2,
                       ifelse(dcat$n_dna==1,1,NA))

dcat$edgrp <- ifelse(is.na(dcat$Education),NA,
      ifelse(dcat$Education < 12,"0-11",
      ifelse(dcat$Education == 12,"12",
      ifelse(dcat$Education <= 16,"13-16",
      ifelse(dcat$Education > 16,"17+",
      NA)))))

# table(dcat$n_serum)
# table(dcat$n_serum)
#	table(dcat$Cohort)
#	table(dcat$synd_ia)
	
	dcat2 <- dcat[,c("ID", "DtLastEval", "GENDER", "Ethnicity", "Education", "age_ia", "RecrSource", "Cohort", "center","synd_ia", "synd_mra","grp","edgrp")]
	ensur <- merge(enr[enr$ProjName=="ADCLC",],dcat2,by="ID")
	
	#	table(ensur$grp)
	
	ensur$MaxTime <- as.numeric((as.Date(ensur$DtLastEval) - ensur$EnrolledDate)/365.25)
	ensur$timeDeath <- ifelse(ensur$LatestDesc=="DECEASED",as.numeric((ensur$LatestDate - ensur$EnrolledDate)/365.25),NA)
	ensur$timeNLF <- ifelse(ensur$LatestDesc=="LOST" | ensur$LatestDesc=="DROPPED" | ensur$LatestDesc=="REFUSED",as.numeric((ensur$LatestDate - ensur$EnrolledDate)/365.25),NA)
	
	ensur$time2NLF <- ifelse(is.na(ensur$timeNLF),ensur$MaxTime,ensur$timeNLF)
	ensur$time2Death <- ifelse(is.na(ensur$timeDeath),ensur$MaxTime,ensur$timeDeath)
	ensur$time7NLF <- ifelse(is.na(ensur$timeNLF),ifelse(ensur$MaxTime>7,7,ensur$MaxTime),ifelse(ensur$timeNLF>7,7,ensur$timeNLF))
	ensur$time7Death <- ifelse(is.na(ensur$timeDeath),ifelse(ensur$MaxTime>7,7,ensur$MaxTime),ifelse(ensur$timeDeath>7,7,ensur$timeDeath))
	ensur$CensorNLF <- ifelse(is.na(ensur$timeNLF),1,0)
	ensur$CensorDeath <- ifelse(is.na(ensur$timeDeath),1,0)
	ensur$Censor7NLF <- ifelse(is.na(ensur$timeNLF),1,ifelse(ensur$timeNLF>7,1,0))
	ensur$Censor7Death <- ifelse(is.na(ensur$timeDeath),1,ifelse(ensur$timeDeath>7,1,0))

	ensur$time9NLF <- ifelse(is.na(ensur$timeNLF),ifelse(ensur$MaxTime>10,10,ensur$MaxTime),ifelse(ensur$timeNLF>10,10,ensur$timeNLF))
	ensur$time9Death <- ifelse(is.na(ensur$timeDeath),ifelse(ensur$MaxTime>10,10,ensur$MaxTime),ifelse(ensur$timeDeath>10,10,ensur$timeDeath))
ensur$Censor9NLF <- ifelse(is.na(ensur$timeNLF),1,ifelse(ensur$timeNLF>10,1,0))
	ensur$Censor9Death <- ifelse(is.na(ensur$timeDeath),1,ifelse(ensur$timeDeath>10,1,0))

dcat$synd_ia <- 
  factor(dcat$synd_ia, 
         labels=c("Demented",
                  "MCI", 
                  "Normal"))
dcat$synd_mra <- 
  factor(dcat$synd_mra, 
         labels=c("Demented",
                  "MCI", 
                  "Normal"))
dcat$grp <- 
  factor(dcat$grp, 
         labels=c("African American",
                  "Hispanic", 
                  "White"))
dcat$grp2 <- 
  factor(dcat$grp2, 
         labels=c("African American",
                  "Hispanic",
                  "Other", 
                  "White"))
dcat$GENDER <- 
  factor(dcat$GENDER, 
         labels=c("Male",
                  "Female"))
dcat$center <- 
  factor(dcat$center, 
         labels=c("East_Bay",
                  "Sacramento"))
dcat$RecrSource <- 
  factor(dcat$RecrSource, 
         labels=c("Clinic",
                  "Community"))
dcat$Cohort <- 
  factor(dcat$Cohort, 
         labels=c("ADNI",
                  "C1",
                  "C2"))
dcat$ClinDxMRA <- 
  factor(dcat$ClinDxMRA, 
         labels=c("AD",
                  "LBD",
                  "CVD",
                  "FTD",
                  "AD+CVD"))
dcat$ClinDxMRA2 <- 
  factor(dcat$ClinDxMRA2, 
         labels=c("AD",
                  "LBD",
                  "CVD",
                  "FTD",
                  "AD+CVD",
                  "MCI",
                  "Normal"))
dcat$PathDx <- 
  factor(dcat$PathDx, 
         labels=c("AD",
                  "LBD",
                  "CVD",
                  "FTD",
                  "AD+CVD",
                  "AD+LBD",
                  "LBD+CVD",
                  "Normal Brain",
                  "AD+Other",
                  "Other"))

dcat$ADCLC_Status <- 
  factor(dcat$ADCLC_Status, 
         labels=c("Active",
                  "Deceased",
                  "Declined",
                  "Dropped",
                  "Ineligible",
                  "Lost",
                  "Pending",
                  "Refused"))

dcat$n_mri_any <- ifelse(is.na(dcat$n_mri) & is.na(dcat$n_mri_3),NA,
      ifelse(is.na(dcat$n_mri),0,dcat$n_mri) + 
      ifelse(is.na(dcat$n_mri_3),0,dcat$n_mri_3))
dcat$n_mri_any <- ifelse(dcat$n_mri_any > 4,4,dcat$n_mri_any)

# table(dcat$ADCLC_Status)
dcat$n_eval  <- factor(dcat$n_eval, labels=c("1","2","3","4","5","6","7","8","9","10+"))
dcat$n_mri  <- factor(dcat$n_mri, labels=c("0","1","2","3","4+"))
dcat$n_mri_any  <- factor(dcat$n_mri_any, labels=c("0","1","2","3","4+"))
dcat$n_mri_3 <- factor(dcat$n_mri_3)
dcat$n_amy <- ifelse(!is.na(dcat$n_pib),dcat$n_pib,0) + ifelse(!is.na(dcat$n_av45),dcat$n_av45,0)
dcat$n_pib <- factor(dcat$n_pib)
dcat$n_amy <- factor(dcat$n_amy)
dcat$n_senas_2  <- factor(dcat$n_senas_2, labels=c("0","1","2","3","4","5","6","7","8","9","10+"))
dcat$n_ivd_npsy_2  <- factor(dcat$n_ivd_npsy_2, labels=c("0","1","2","3","4","5","6","7","8","9","10+"))
dcat$n_serum  <- factor(dcat$n_serum, labels=c("1","2+"))
dcat$n_plasma  <- factor(dcat$n_plasma, labels=c("1","2+"))
# dna temporarily removed - bad values in query 06-26-17
# dcat$n_dna  <- factor(dcat$n_dna, labels=c("1","2+"))
# table(dcat$n_serum)
# table(dcat$n_mri)
# table(dcat$n_dna)

colnames(asl1) <- gsub("SubjectStudyID","ID",colnames(asl1))
colnames(asl1) <- gsub("ADC_ID","ID",colnames(asl1))
# asl1$ID <- as.numeric(asl1$ID)
asl1$VDate <- as.Date(as.character(asl1$VDate), format="%m/%d/%Y")

asl1 <- asl1[!asl1$ID == 999999,] # exclude 999999

colnames(hlth) <- gsub("SubjectStudyID","ID",colnames(hlth))
# colnames(hlth) <- gsub("ADC_ID","ID",colnames(hlth))
hlth$ClinVisitDate <- as.Date(as.character(hlth$ClinVisitDate), format="%m/%d/%Y")
hlth$diab <- as.factor(ifelse(hlth$DIABETES==1,"Yes","No"))
hlth$htn <- as.factor(ifelse(hlth$HYPERTEN==1,"Yes","No"))
hlth$hlip <- as.factor(ifelse(hlth$HYPERCHO==1,"Yes","No"))
hlth$stroke <- as.factor(ifelse(hlth$CBSTROKE %in% c(1,2),"Yes","No"))
hlth$tia <- as.factor(ifelse(hlth$CBTIA %in% c(1,2),"Yes","No"))

hlth <- hlth[!hlth$ID == 999999,] # exclude 999999

hlth2 <- merge(hlth[,c("ID","ClinVisitDate","diab","htn","hlip","stroke","tia")],
    asl1[asl1$VisitType %in% "Office",c("ID","VDate","FirstEval","LastOfficeEval")],by.x=c("ID","ClinVisitDate"),by.y=c("ID","VDate"))
hlth1 <- hlth2[hlth2$FirstEval %in% "Yes",c("ID","diab","htn","hlip","stroke","tia")]
colnames(hlth1) <- c("ID","diab1","htn1","hlip1","stroke1","tia1")
hlth2 <- hlth2[hlth2$LastOfficeEval %in% "Yes",]

dcat <- merge(dcat,hlth1[,c("ID","diab1","htn1","hlip1","stroke1","tia1")],by="ID",all.x=TRUE)
dcat <- merge(dcat,hlth2[,c("ID","diab","htn","hlip","stroke","tia")],by="ID",all.x=TRUE)
	
	# A function that takes the variable name,  group by variable name, and dataset name
# and then runs descriptive statistics for the variable by group
getT1Stat <- function(varname, byname, dfname, digits=1, html=TRUE, hrzl_prop=FALSE){
  getDescriptionStatsBy(dfname[, varname], 
                        dfname[, byname], 
                        add_total_col=TRUE,
                        show_all_values=TRUE, 
                        hrzl_prop=hrzl_prop,
                        statistics=FALSE, 
                        html=html, 
                        digits=digits)
}


# A function that merges results from getT1Stat into a matrix
# and creates the output data, rgroup & n.rgroup variables for latex()
descStatTable <- function(table_data){
  rgroup <- c()
	n.rgroup <- c()
	output_data <- NULL
	for (varlabel in names(table_data)){
  	output_data <- rbind(output_data, 
                       table_data[[varlabel]])
  	rgroup <- c(rgroup, 
              varlabel)
  	n.rgroup <- c(n.rgroup, 
                nrow(table_data[[varlabel]]))
	} 
	table_out <- list("output_data"=output_data,"rgroup"=rgroup,"n.rgroup"=n.rgroup) 
}
	
# This function takes results generated by decStatTable and makes all component tables
# have the same columns in the same order to facilitate merging of tables
tableBalance <- function(table_data){
#   cnm <- colnames(table_data[[1]])
#   for (i in 2:length(table_data)) {
#     cnm <- c(cnm,colnames(table_data[[i]]))
#   }
#   cnm <- unique(cnm)
 
  lapply(table_data, function(x) {
    for (i in 1:length(cnm)){
      if (!cnm[i] %in% colnames(x)) {
        x <- cbind(x, rep("0 (0.0%)",nrow(x)))
        colnames(x)[ncol(x)] <- cnm[i]
      }
    }
    z <- NULL
    for (i in 1:length(cnm)){
      z <- cbind(z,x[,cnm[i]])
    }
    colnames(z) <- cnm
    
    z
  }
  )
}

#  Output recoded data catalog by uncommented following line
write.csv(dcat,file="Output Files/adc_data_catalog.csv",row.names=FALSE)
saveRDS(dcat,file="Output Files/adc_data_catalog.rds")

```

##  Longitudinal Cohort Characteristics

#### Characteristics of the currently active longitudinal cohort by the most recent clinical diagnosis

<!--  active most recent by current dx -->


```{r, label="active_syndr_mra",results="asis",message=FALSE,echo=FALSE, warning=FALSE}

# library("Gmisc")
# library("Hmisc")

                  
dcat1 <- dcat[dcat$ADCLC_Status %in% "Active" & !dcat$ID==999999 & !is.na(dcat$synd_mra) & is.na(dcat$ADNI),]  
n_adni <- nrow(dcat[dcat$ADCLC_Status %in% "Active" & dcat$Cohort %in% "ADNI",])  
n_no_dx <- nrow(dcat[dcat$ADCLC_Status %in% "Active" & !dcat$ID==999999 & is.na(dcat$synd_mra) & is.na(dcat$ADNI),])

 
# Generate descriptive statistics and save into a list
# This simplifies the row grouping 
table_data <- list()
 
# Get the basic stats
table_data[["Syndrome\\_Dx\\_IA"]] <- getT1Stat("synd_ia","synd_mra",dcat1)
table_data[["Gender"]] <- getT1Stat("GENDER","synd_mra",dcat1)
table_data[["Race/Ethnicity"]] <- getT1Stat("grp2","synd_mra",dcat1)
table_data[["Recruitment Source"]] <- getT1Stat("RecrSource","synd_mra",dcat1)
table_data[["Age\\_IA"]] <- getT1Stat("age_ia","synd_mra",dcat1)
table_data[["Age\\_Current"]] <- getT1Stat("age_cur","synd_mra",dcat1)
table_data[["Education"]] <- getT1Stat("Education","synd_mra",dcat1)
table_data[["N Evals Continuous"]] <- getT1Stat("NMMS","synd_mra",dcat1)
table_data[["N SENAS Evals"]] <- getT1Stat("n_senas_2","synd_mra",dcat1)
table_data[["N IVD Evals"]] <- getT1Stat("n_ivd_npsy_2","synd_mra",dcat1)
table_data[["N 1.5T MRI"]] <- getT1Stat("n_mri","synd_mra",dcat1)
table_data[["N 3T MRI"]] <- getT1Stat("n_mri_3","synd_mra",dcat1)
table_data[["N Any MRI"]] <- getT1Stat("n_mri_any","synd_mra",dcat1)
table_data[["N Amyloid PET"]] <- getT1Stat("n_amy","synd_mra",dcat1)
table_data[["N Serum Samples"]] <- getT1Stat("n_serum","synd_mra",dcat1)
table_data[["N Plasma Samples"]] <- getT1Stat("n_plasma","synd_mra",dcat1)
# table_data[["N DNA Samples"]] <- getT1Stat("n_dna","synd_mra",dcat1)
table_data[["Diabetes<sup>a</sup>"]] <- getT1Stat("diab","synd_mra",dcat1)
table_data[["Hypertension<sup>a</sup>"]] <- getT1Stat("htn","synd_mra",dcat1)
table_data[["Hypercholesterolemia<sup>a</sup>"]] <- getT1Stat("hlip","synd_mra",dcat1)
table_data[["Stroke<sup>a</sup>"]] <- getT1Stat("stroke","synd_mra",dcat1)
table_data[["Transient Ischemic Attack<sup>a</sup>"]] <- getT1Stat("tia","synd_mra",dcat1)

#	generate output data for table
out_data <- descStatTable(table_data)
out_data$output_data <- out_data$output_data[,c(2:ncol(out_data$output_data),1)]

cgroup <- c("Clinical Diagnosis, Most Recent Evaluation","")
n.cgroup <- c(3,1)


#	generate latex code for table
# latex(out_data$output_data,
#           rgroup=out_data$rgroup, n.rgroup=out_data$n.rgroup, 
#         file="", title="",caption=paste("Characteristics of currently active longitudinal cohort. Total N = ",nrow(dcat1)," (excluding ",n_adni," ADNI cases).",sep=""),
#         label="adclc_mra",booktabs=TRUE, where="!htbp",cgroup=cgroup,n.cgroup=n.cgroup,longtable=TRUE)

# generate html code for table
htmlTable(out_data$output_data, align="rrrr",
          rgroup=out_data$rgroup, n.rgroup=out_data$n.rgroup, 
          # rgroupCSSseparator="", 
          cgroup = cgroup,
          n.cgroup = n.cgroup,
          rowlabel="", 
          caption=paste("Characteristics of currently active longitudinal cohort. Total N = ",nrow(dcat1)," (excluding ",n_adni," ADNI cases and ",n_no_dx," cases pending diagnosis).",sep=""), 
          tfoot="<sup>a</sup> At most recent clinical assessment",
          ctable=TRUE)
        
```

*****

<!--  active, most recent by ethnicity   -->
   
####  Characteristics of the current active cohort by race/ethnicity


```{r,label="active_eth",echo=FALSE, message=FALSE, warning=FALSE, results="asis"}

# Generate descriptive statistics and save into a list
# This simplifies the row grouping 
table_data <- list()
 
# Get the basic stats
table_data[["Syndrome\\_Dx\\_IA"]] <- getT1Stat("synd_ia","grp2",dcat1)
table_data[["Syndrome\\_Dx\\_MRA"]] <- getT1Stat("synd_mra","grp2",dcat1)
table_data[["Gender"]] <- getT1Stat("GENDER","grp2",dcat1)
table_data[["Recruitment Source"]] <- getT1Stat("RecrSource","grp2",dcat1)
table_data[["Age\\_IA"]] <- getT1Stat("age_ia","grp2",dcat1)
table_data[["Age\\_Current"]] <- getT1Stat("age_cur","grp2",dcat1)
table_data[["Education"]] <- getT1Stat("Education","grp2",dcat1)
table_data[["N Evals Continuous"]] <- getT1Stat("NMMS","grp2",dcat1)
table_data[["N SENAS Evals"]] <- getT1Stat("n_senas_2","grp2",dcat1)
table_data[["N IVD Evals"]] <- getT1Stat("n_ivd_npsy_2","grp2",dcat1)
table_data[["N 1.5T MRI"]] <- getT1Stat("n_mri","grp2",dcat1)
table_data[["N 3T MRI"]] <- getT1Stat("n_mri_3","grp2",dcat1)
table_data[["N Any MRI"]] <- getT1Stat("n_mri_any","grp2",dcat1)
table_data[["N Amyloid PET"]] <- getT1Stat("n_amy","grp2",dcat1)
table_data[["N Serum Samples"]] <- getT1Stat("n_serum","grp2",dcat1)
table_data[["N Plasma Samples"]] <- getT1Stat("n_plasma","grp2",dcat1)
# table_data[["N DNA Samples"]] <- getT1Stat("n_dna","grp2",dcat1)
table_data[["Diabetes<sup>a</sup>"]] <- getT1Stat("diab","grp2",dcat1)
table_data[["Hypertension<sup>a</sup>"]] <- getT1Stat("htn","grp2",dcat1)
table_data[["Hypercholesterolemia<sup>a</sup>"]] <- getT1Stat("hlip","grp2",dcat1)
table_data[["Stroke<sup>a</sup>"]] <- getT1Stat("stroke","grp2",dcat1)
table_data[["Transient Ischemic Attack<sup>a</sup>"]] <- getT1Stat("tia","grp2",dcat1)

#	generate output data for table
out_data <- descStatTable(table_data)
out_data$output_data <- out_data$output_data[,c(2,3,5,4,1)]

cgroup <- c("Racial/Ethnic Group","")
n.cgroup <- c(4,1)


#	generate latex code for table
# latex(out_data$output_data,
#           rgroup=out_data$rgroup, n.rgroup=out_data$n.rgroup, 
#         file="", title="",caption=paste("Characteristics of currently active longitudinal cohort. Total N = ",nrow(dcat1)," (excluding ",n_adni," ADNI cases).",sep=""),
#         label="adclc_mra_eth",booktabs=TRUE, where="!htbp",cgroup=cgroup,n.cgroup=n.cgroup,longtable=TRUE)   

# generate html code for table
htmlTable(out_data$output_data, align="rrrr",
          rgroup=out_data$rgroup, n.rgroup=out_data$n.rgroup, 
          # rgroupCSSseparator="", 
          cgroup = cgroup,
          n.cgroup = n.cgroup,
          rowlabel="", 
          caption=paste("Characteristics of currently active longitudinal cohort. Total N = ",nrow(dcat1)," (excluding ",n_adni," ADNI cases and ",n_no_dx," cases pending diagnosis).",sep=""), 
          tfoot="<sup>a</sup> At most recent clinical assessment",
          ctable=TRUE)

```

*****

<!--  enrolled, longitudinal analysis sample, 2+ SENAS   -->

#### Characteristics of the available longitudinal analysis sample with $\geq2$ SENAS evaluations by baseline diagnosis


```{r, label="longit_senas",echo=FALSE, message=FALSE, warning=FALSE, results="asis"}

dcat1 <- dcat[dcat$ADCLC_Enroll=="Enrolled" & !dcat$ID==999999 & as.integer(dcat$n_senas)>=2,]  

# Generate descriptive statistics and save into a list
# This simplifies the row grouping 

table_data <- list()
 
# Get the basic stats
table_data[["Current Status in ADCLC"]] <- getT1Stat("ADCLC_Status","synd_ia",dcat1)
table_data[["Gender"]] <- getT1Stat("GENDER","synd_ia",dcat1)
table_data[["Syndrome Dx MRA"]] <- getT1Stat("synd_mra","synd_ia",dcat1)
table_data[["Race/Ethnicity"]] <- getT1Stat("grp2","synd_ia",dcat1)
table_data[["Recruitment Source"]] <- getT1Stat("RecrSource","synd_ia",dcat1)
table_data[["Age IA"]] <- getT1Stat("age_ia","synd_ia",dcat1)
table_data[["Education"]] <- getT1Stat("Education","synd_ia",dcat1)
table_data[["N SENAS Evals"]] <- getT1Stat("n_senas_2","synd_ia",dcat1)
table_data[["N 1.5T MRI"]] <- getT1Stat("n_mri","synd_ia",dcat1)
table_data[["N 3T MRI"]] <- getT1Stat("n_mri_3","synd_ia",dcat1)
table_data[["N Any MRI"]] <- getT1Stat("n_mri_any","synd_ia",dcat1)
table_data[["N Amyloid PET"]] <- getT1Stat("n_amy","synd_ia",dcat1)
table_data[["N Serum Samples"]] <- getT1Stat("n_serum","synd_ia",dcat1)
table_data[["N Plasma Samples"]] <- getT1Stat("n_plasma","synd_ia",dcat1)
# table_data[["N DNA Samples"]] <- getT1Stat("n_dna","synd_ia",dcat1)
table_data[["Diabetes<sup>a</sup>"]] <- getT1Stat("diab","synd_ia",dcat1)
table_data[["Hypertension<sup>a</sup>"]] <- getT1Stat("htn","synd_ia",dcat1)
table_data[["Hypercholesterolemia<sup>a</sup>"]] <- getT1Stat("hlip","synd_ia",dcat1)
table_data[["Stroke<sup>a</sup>"]] <- getT1Stat("stroke","synd_ia",dcat1)
table_data[["Transient Ischemic Attack<sup>a</sup>"]] <- getT1Stat("tia","synd_ia",dcat1)

#	generate output data for table
out_data <- descStatTable(table_data)
out_data$output_data <- out_data$output_data[,c(2:ncol(out_data$output_data),1)]

cgroup <- c("Clinical Diagnosis, Baseline Evaluation","")
n.cgroup <- c(3,1)

#	generate latex code for table
# latex(out_data$output_data,
#           rgroup=out_data$rgroup, n.rgroup=out_data$n.rgroup, 
#         file="", title="",caption="Characteristics of  longitudinal sample with 2+ SENAS evaluations by baseline diagnosis.",
#         label="adclc_anal_dx",booktabs=TRUE, where="!htbp",cgroup=cgroup,n.cgroup=n.cgroup, longtable=TRUE)   

# generate html code for table
htmlTable(out_data$output_data, align="rrrr",
          rgroup=out_data$rgroup, n.rgroup=out_data$n.rgroup, 
          # rgroupCSSseparator="", 
          cgroup = cgroup,
          n.cgroup = n.cgroup,
          rowlabel="", 
          caption="Characteristics of  longitudinal sample with 2+ SENAS evaluations by baseline diagnosis.", 
           tfoot="<sup>a</sup> At first clinical assessment",
           ctable=TRUE)

```

******


<!--  enrolled, longitudinal analysis sample, 2+ SENAS or IVD  -->

#### Characteristics of the available longitudinal analysis sample with $\geq2$ SENAS or IVD neuropsychological evaluations by baseline diagnosis


```{r, label="longit_senas_ivd",echo=FALSE, warning=FALSE, results="asis"}

dcat1 <- dcat[dcat$ADCLC_Enroll=="Enrolled" & !dcat$ID==999999 & (as.integer(dcat$n_senas)>=2 | as.integer(dcat$n_ivd_npsy)>=2),]  

#  Output recoded data catalog by uncommented following line
# write.csv(dcat1,file="Output Files/adc_data_catalog_ge2_cogn.csv",row.names=FALSE)
# saveRDS(dcat,file="Output Files/adc_data_catalog_ge2_cogn.rds")


# Generate descriptive statistics and save into a list
# This simplifies the row grouping 

table_data <- list()
 
# Get the basic stats
table_data[["Current Status in ADCLC"]] <- getT1Stat("ADCLC_Status","synd_ia",dcat1)
table_data[["Gender"]] <- getT1Stat("GENDER","synd_ia",dcat1)
table_data[["Syndrome Dx MRA"]] <- getT1Stat("synd_mra","synd_ia",dcat1)
table_data[["Race/Ethnicity"]] <- getT1Stat("grp2","synd_ia",dcat1)
table_data[["Recruitment Source"]] <- getT1Stat("RecrSource","synd_ia",dcat1)
table_data[["Age IA"]] <- getT1Stat("age_ia","synd_ia",dcat1)
table_data[["Education"]] <- getT1Stat("Education","synd_ia",dcat1)
table_data[["N SENAS Evals"]] <- getT1Stat("n_senas_2","synd_ia",dcat1)
table_data[["N IVD Evals"]] <- getT1Stat("n_ivd_npsy_2","synd_ia",dcat1)
table_data[["N 1.5T MRI"]] <- getT1Stat("n_mri","synd_ia",dcat1)
table_data[["N 3T MRI"]] <- getT1Stat("n_mri_3","synd_ia",dcat1)
table_data[["N Any MRI"]] <- getT1Stat("n_mri_any","synd_ia",dcat1)
table_data[["N Amyloid PET"]] <- getT1Stat("n_amy","synd_ia",dcat1)
table_data[["N Serum Samples"]] <- getT1Stat("n_serum","synd_ia",dcat1)
table_data[["N Plasma Samples"]] <- getT1Stat("n_plasma","synd_ia",dcat1)
# table_data[["N DNA Samples"]] <- getT1Stat("n_dna","synd_ia",dcat1)
table_data[["Diabetes<sup>a</sup>"]] <- getT1Stat("diab","synd_ia",dcat1)
table_data[["Hypertension<sup>a</sup>"]] <- getT1Stat("htn","synd_ia",dcat1)
table_data[["Hypercholesterolemia<sup>a</sup>"]] <- getT1Stat("hlip","synd_ia",dcat1)
table_data[["Stroke<sup>a</sup>"]] <- getT1Stat("stroke","synd_ia",dcat1)
table_data[["Transient Ischemic Attack<sup>a</sup>"]] <- getT1Stat("tia","synd_ia",dcat1)

#	generate output data for table
out_data <- descStatTable(table_data)
out_data$output_data <- out_data$output_data[,c(2:ncol(out_data$output_data),1)]

cgroup <- c("Clinical Diagnosis, Baseline Evaluation","")
n.cgroup <- c(3,1)

#	generate latex code for table
# latex(out_data$output_data,
#           rgroup=out_data$rgroup, n.rgroup=out_data$n.rgroup, 
#         file="", title="",caption="Characteristics of  longitudinal sample with 2+ SENAS or IVD evaluations by baseline diagnosis.",
#         label="adclc_anal_dx_2",booktabs=TRUE, where="!htbp",longtable=TRUE,cgroup=cgroup,n.cgroup=n.cgroup)   

# generate html code for table
htmlTable(out_data$output_data, align="rrrr",
          rgroup=out_data$rgroup, n.rgroup=out_data$n.rgroup, 
          # rgroupCSSseparator="", 
          cgroup = cgroup,
          n.cgroup = n.cgroup,
          rowlabel="", 
          caption="Characteristics of  longitudinal sample with 2+ SENAS or IVD evaluations by baseline diagnosis.", 
          tfoot="<sup>a</sup> At first clinical assessment",
          ctable=TRUE)


```

*****

## Enrollment and Cohort Composition


```{r, label=enr_stat_prelim, results="hide", message=FALSE, warning=FALSE, echo=FALSE}

#	Create enrollment and status by year and ethnicity tables

# library(doBy)
# library(plyr)

#	enr <- read.table("enrollment_07-17-14.csv", header=TRUE, sep=",", na.strings = "")
#	dcat <- read.table("adc_data_catalog_07-10-14.csv", header=TRUE, sep=",", na.strings = "")
#	colnames(dcat)[2] <- "ID"

# dc=Data Table("adc_data_catalog_02-18-14.jmp");
# dt1=Data Table( "enrollment_02-10-14.jmp" ) << Select All Rows<<Sort(
	# By( :ID),
	# Order( Ascending)
# );

# enr$LatestDate <- as.Date(enr$LatestDate)
# enr$EnrolledDate <- as.Date(enr$EnrolledDate)
# enr$DroppedDate <- as.Date(enr$DroppedDate)
# enr$LostDate <- as.Date(enr$LostDate)
# enr$RefusedDate <- as.Date(enr$RefusedDate)
# enr$DeceasedDate <- as.Date(enr$DeceasedDate)

# enradc <- enr[enr$ProjName %in% "ADC" & !is.na(enr$EnrolledDate),c("ID", "EnrolledDate", "ProjName")]
# dc1 <- dcat[,c("ID","Ethnicity","GENDER","RACE")]
# enradc <- merge(enradc,dc1,by="ID")

lc <- enr[enr$ProjName == "ADCLC" & !is.na(enr$EnrolledDate),c("ID","ProjName","EnrolledDate")]
lc$YearEnrLC <- as.numeric(format(lc$EnrolledDate, "%Y"))
enr <- merge(enr,lc[,c("ID","YearEnrLC")], by="ID")

enr1 <- enr
enr1$YearEnr <- as.numeric(format(enr1$EnrolledDate, "%Y"))
enr2 <- enr1[!is.na(enr$EnrolledDate),c("ID", "LatestDesc","EnrolledDate", "ProjName", "YearEnr", "YearEnrLC")]
enr2$EnrolledDesc <- "ENROLLED"

#	table(enr2$ProjName)

dc1 <- dcat[,c("ID","Ethnicity","GENDER","RACE")]
enr2 <- merge(enr2,dc1,by="ID")

# enr3 <- summaryBy(ID ~ YearEnr + ProjName + Ethnicity, data = enr2, FUN=c(length))
# colnames(enr3)[4] <- "N"

# enr3$Ethnicity <- factor(enr3$Ethnicity)
# enr3$YearEnr <- factor(enr3$YearEnr)

# enr4 <- split(enr3, list(enr3$ProjName))

# for(i in 1:length(enr4)){
	# if (i==1){
		# enr5 <- as.data.frame(enr4[1])[,c(1,3,4)]
		# colnames(enr5)[1:2] <- c("YearEnr","Ethnicity")		
	# } else {
		# enrt <- as.data.frame(enr4[i])[,c(1,3,4)]
		# colnames(enrt)[1:2] <- c("YearEnr","Ethnicity")
		# enr5 <- merge(enr5,enrt,by=c("YearEnr","Ethnicity"),all=TRUE)		
	# }
# }


enr3 <- ddply(enr2[!is.na(enr2$Ethnicity),], .(YearEnrLC, Ethnicity, ProjName), summarise,
N = length(ID))

# enr3 <- ddply(enr2[!is.na(enr2$Ethnicity) & enr2$YearEnr == enr2$YearEnrLC,], .(YearEnr, Ethnicity, ProjName), summarise,
# N = length(ID))

#	Cohort enrollment by year and ethnicity

for (x in 1986:cur_yr){
  if(!x %in% enr3$YearEnrLC){
    rval <- data.frame(YearEnrLC = x, Ethnicity = 9, ProjName = "ADCLC", N = 0)
    enr3 <- rbind(enr3,rval)
  }
}

enr4 <- ddply(enr3, .(YearEnrLC, Ethnicity), summarise, 
	ADCLC.N = sum(ifelse(ProjName=="ADCLC",N,0)),
	C1.N = sum(ifelse(ProjName=="C1",N,0)),
	C2.N = sum(ifelse(ProjName=="C2",N,0)),
	Hillblom.N = sum(ifelse(ProjName=="Hillblom",N,0)),
	IVD.N = sum(ifelse(ProjName=="IVD",N,0)),
	ADNI.N = sum(ifelse(ProjName=="ADNI",N,0)))
	

#	Cohort 2 by year and ethnicity

enr5 <- ddply(enr4, .(YearEnrLC), summarise, 
	African_American.C2.N = sum(ifelse(Ethnicity==4,C2.N,0)),
	Hispanic.C2.N = sum(ifelse(Ethnicity==6, C2.N,0)),
	White.C2.N = sum(ifelse(Ethnicity==7, C2.N,0)),
	Other.C2.N = sum(ifelse(Ethnicity %in% c(1,2,3,5,8), C2.N,0))
	)
	
	enr5$Total <- enr5$African_American.C2.N + enr5$Hispanic.C2.N + enr5$White.C2.N + enr5$Other.C2.N 

#	ADCLC by year and ethnicity

enr6 <- ddply(enr4, .(YearEnrLC), summarise, 
	African_American.ADCLC.N = sum(ifelse(Ethnicity==4,ADCLC.N,0)),
	Hispanic.ADCLC.N = sum(ifelse(Ethnicity==6, ADCLC.N,0)),
	White.ADCLC.N = sum(ifelse(Ethnicity==7, ADCLC.N,0)),
	Other.ADCLC.N = sum(ifelse(Ethnicity %in% c(1,2,3,5,8), ADCLC.N,0))
	)

	enr6$Total <- enr6$African_American.ADCLC.N + enr6$Hispanic.ADCLC.N + enr6$White.ADCLC.N + enr6$Other.ADCLC.N

#	----------------------------------------------------------------------------------------------------
#	Enrollment Status
#	----------------------------------------------------------------------------------------------------


#	ADCLC by year and ethnicity


enrst <- enr[enr$ProjName=="ADCLC",]

for (yr in 2001:cur_yr){
	lbl <- paste("Status_",yr,sep="")
	dt <- paste(yr,"-12-31",sep="")
	enrst[,lbl] <- ifelse(is.na(enrst$EnrolledDate),"Not_Enrolled",ifelse(!is.na(enrst$RefusedDate) & enrst$RefusedDate <= dt & enrst$RefusedDate >= enrst$EnrolledDate,"Refused",ifelse(!is.na(enrst$DroppedDate) & enrst$DroppedDate <= dt & enrst$DroppedDate >= enrst$EnrolledDate,"Dropped",ifelse(!is.na(enrst$DeceasedDate) & enrst$DeceasedDate <= dt & enrst$DeceasedDate >= enrst$EnrolledDate,"Deceased",ifelse(!is.na(enrst$LostDate) & enrst$LostDate <= dt & enrst$LostDate >= enrst$EnrolledDate,"Lost",ifelse(enrst$EnrolledDate <= dt,"Active",NA))))))	
}

dcat1 <- dcat[,c("ID","Ethnicity", "ADCLC_Status")]
enrst1 <- merge(enrst,dcat1,by="ID")
#	enrst1 <- enrst1[enrst1$ADCLC_Status=="Active",]
#	nrow(enrst1)
enrst1 <- enrst1[!is.na(enrst1$Ethnicity),]

cnmst <- sapply(2001:cur_yr, function(x) paste("Status_",x,sep=""))
enrst2 <- data.frame(enrst1[,c("ID","Ethnicity")], stack(enrst1[,cnmst]))
enrst2 <- enrst2[with(enrst2,order(ID)),]

# enrst2 <- data.frame(enrst1[,c("ID","Ethnicity")], stack(enrst1[,c("Status_2001","Status_2002","Status_2003","Status_2004", "Status_2005","Status_2006","Status_2007","Status_2008","Status_2009","Status_2010","Status_2011","Status_2012", "Status_2013","Status_2014")]))
# enrst2 <- enrst2[with(enrst2,order(ID)),]

enrst2$year <- substr(enrst2 $ind,8,11)
enrst2 <- enrst2[!is.na(enrst2$values),]
enrst2 <- enrst2[enrst2$values=="Active",]


enrst3 <- ddply(enrst2, .(Ethnicity, year), summarise,
	N = length(ID))
	

enrst4 <- ddply(enrst3, .(year), summarise, 
	African_American.ADCLC.N = sum(ifelse(Ethnicity==4,N,0)),
	Hispanic.ADCLC.N = sum(ifelse(Ethnicity==6, N,0)),
	White.ADCLC.N = sum(ifelse(Ethnicity==7, N,0)),
	Other.ADCLC.N = sum(ifelse(Ethnicity %in% c(1,2,3,5,8), N,0))
	)
	
enrst4$Total <- enrst4$African_American.ADCLC.N + enrst4$Hispanic.ADCLC.N + enrst4$White.ADCLC.N + enrst4$Other.ADCLC.N	


#	C2 by year and ethnicity with transfers

enrstc2 <- enr[enr$ProjName=="C2",]

for (yr in 2001:cur_yr){
	lbl <- paste("Status_",yr,sep="")
	dt <- paste(yr,"-12-31",sep="")
	enrstc2[,lbl] <- ifelse(is.na(enrstc2$EnrolledDate),"Not_Enrolled",ifelse(!is.na(enrstc2$RefusedDate) & enrstc2$RefusedDate <= dt & enrstc2$RefusedDate >= enrstc2$EnrolledDate,"Refused",ifelse(!is.na(enrstc2$DroppedDate) & enrstc2$DroppedDate <= dt & enrstc2$DroppedDate >= enrstc2$EnrolledDate,"Dropped",ifelse(!is.na(enrstc2$DeceasedDate) & enrstc2$DeceasedDate <= dt & enrstc2$DeceasedDate >= enrstc2$EnrolledDate,"Deceased",ifelse(!is.na(enrstc2$LostDate) & enrstc2$LostDate <= dt & enrstc2$LostDate >= enrstc2$EnrolledDate,"Lost",ifelse(enrstc2$EnrolledDate <= dt,"Active",NA))))))	
}

dcat1 <- dcat[,c("ID","Ethnicity", "ADCLC_Status")]
enrstc21 <- merge(enrstc2,dcat1,by="ID")
#	enrstc21 <- enrstc21[enrstc21$ADCLC_Status=="Active",]
#	nrow(enrstc21)
enrstc21 <- enrstc21[!is.na(enrstc21$Ethnicity),]

#	enrstc21[,c("ID","Ethnicity","Status_2001","Status_2002","Status_2003","Status_2004", "Status_2005","Status_2006","Status_2007","Status_2008","Status_2009","Status_2010","Status_2011","Status_2012", "Status_2013","Status_2014")]

enrstc22 <- data.frame(enrstc21[,c("ID","Ethnicity")], stack(enrstc21[,cnmst]))
enrstc22 <- enrstc22[with(enrstc22,order(ID)),]

# enrstc22 <- data.frame(enrstc21[,c("ID","Ethnicity")], stack(enrstc21[,c("Status_2001","Status_2002","Status_2003","Status_2004", "Status_2005","Status_2006","Status_2007","Status_2008","Status_2009","Status_2010","Status_2011","Status_2012", "Status_2013","Status_2014")]))
# enrstc22 <- enrstc22[with(enrstc22,order(ID)),]

enrstc22$year <- substr(enrstc22 $ind,8,11)
enrstc22 <- enrstc22[!is.na(enrstc22$values),]
enrstc22 <- enrstc22[enrstc22$values=="Active",]


enrstc23 <- ddply(enrstc22, .(Ethnicity, year), summarise,
	N = length(ID))
	

enrstc24 <- ddply(enrstc23, .(year), summarise, 
	African_American.C2.N = sum(ifelse(Ethnicity==4,N,0)),
	Hispanic.C2.N = sum(ifelse(Ethnicity==6, N,0)),
	White.C2.N = sum(ifelse(Ethnicity==7, N,0)),
	Other.C2.N = sum(ifelse(Ethnicity %in% c(1,2,3,5,8), N,0))
	)
	
enrstc24$Total <- enrstc24$African_American.C2.N + enrstc24$Hispanic.C2.N + enrstc24$White.C2.N + enrstc24$Other.C2.N	


#	C2 by year and ethnicity without transfers

enrstc2t <- enr[enr$ProjName=="C2",]

enrstivd <- enr[grepl("IVD",enr$ProjName) & !is.na(enr$EnrolledDate),c("ID","EnrolledDate")]
colnames(enrstivd) <- c("ID","IVD_Enr_Date")
enrstc1 <- enr[enr$ProjName=="C1" & !is.na(enr$EnrolledDate),c("ID","EnrolledDate")]
colnames(enrstc1) <- c("ID","C1_Enr_Date")
enrstadni <- enr[enr$ProjName=="ADNI" & !is.na(enr$EnrolledDate),c("ID","EnrolledDate")]
colnames(enrstadni) <- c("ID","ADNI_Enr_Date")

enrstc2t <- merge(enrstc2t,enrstivd,by="ID",all.x=TRUE)
enrstc2t <- merge(enrstc2t,enrstc1,by="ID",all.x=TRUE)
enrstc2t <- merge(enrstc2t,enrstadni,by="ID",all.x=TRUE)
enrstc2t <- enrstc2t[(is.na(enrstc2t$IVD_Enr_Date) | enrstc2t$IVD_Enr_Date > enrstc2t$EnrolledDate) & (is.na(enrstc2t$C1_Enr_Date) | enrstc2t$C1_Enr_Date > enrstc2t$EnrolledDate) & (is.na(enrstc2t$ADNI_Enr_Date) | enrstc2t$ADNI_Enr_Date > enrstc2t$EnrolledDate),]


for (yr in 2001:cur_yr){
	lbl <- paste("Status_",yr,sep="")
	dt <- paste(yr,"-12-31",sep="")
	enrstc2t[,lbl] <- ifelse(is.na(enrstc2t$EnrolledDate),"Not_Enrolled",ifelse(!is.na(enrstc2t$RefusedDate) & enrstc2t$RefusedDate <= dt & enrstc2t$RefusedDate >= enrstc2t$EnrolledDate,"Refused",ifelse(!is.na(enrstc2t$DroppedDate) & enrstc2t$DroppedDate <= dt & enrstc2t$DroppedDate >= enrstc2t$EnrolledDate,"Dropped",ifelse(!is.na(enrstc2t$DeceasedDate) & enrstc2t$DeceasedDate <= dt & enrstc2t$DeceasedDate >= enrstc2t$EnrolledDate,"Deceased",ifelse(!is.na(enrstc2t$LostDate) & enrstc2t$LostDate <= dt & enrstc2t$LostDate >= enrstc2t$EnrolledDate,"Lost",ifelse(enrstc2t$EnrolledDate <= dt,"Active",NA))))))	
}

dcat1 <- dcat[,c("ID","Ethnicity", "ADCLC_Status")]
enrstc2t1 <- merge(enrstc2t,dcat1,by="ID")
#	enrstc2t1 <- enrstc2t1[enrstc2t1$ADCLC_Status=="Active",]
#	nrow(enrstc2t1)
enrstc2t1 <- enrstc2t1[!is.na(enrstc2t1$Ethnicity),]

#	enrstc2t1[,c("ID","Ethnicity","Status_2001","Status_2002","Status_2003","Status_2004", "Status_2005","Status_2006","Status_2007","Status_2008","Status_2009","Status_2010","Status_2011","Status_2012", "Status_2013","Status_2014")]

enrstc2t2 <- data.frame(enrstc2t1[,c("ID","Ethnicity")], stack(enrstc2t1[,cnmst]), row.names=NULL)
enrstc2t2 <- enrstc2t2[with(enrstc2t2,order(ID)),]

# enrstc2t2 <- data.frame(enrstc2t1[,c("ID","Ethnicity")], stack(enrstc2t1[,c("Status_2001","Status_2002","Status_2003","Status_2004", "Status_2005","Status_2006","Status_2007","Status_2008","Status_2009","Status_2010","Status_2011","Status_2012", "Status_2013","Status_2014")]))
# enrstc2t2 <- enrstc2t2[with(enrstc2t2,order(ID)),]

enrstc2t2$year <- substr(enrstc2t2 $ind,8,11)
enrstc2t2 <- enrstc2t2[!is.na(enrstc2t2$values),]
enrstc2t2 <- enrstc2t2[enrstc2t2$values=="Active",]

#	table(enrstc2t2$values)

enrstc2t3 <- ddply(enrstc2t2, .(Ethnicity, year), summarise,
	N = length(ID))
	

enrstc2t4 <- ddply(enrstc2t3, .(year), summarise, 
	African_American.C2.N = sum(ifelse(Ethnicity==4,N,0)),
	Hispanic.C2.N = sum(ifelse(Ethnicity==6, N,0)),
	White.C2.N = sum(ifelse(Ethnicity==7, N,0)),
	Other.C2.N = sum(ifelse(Ethnicity %in% c(1,2,3,5,8), N,0))
	)
	
enrstc2t4$Total <- enrstc2t4$African_American.C2.N + enrstc2t4$Hispanic.C2.N + enrstc2t4$White.C2.N + enrstc2t4$Other.C2.N

#	Autopsy by year and ethnicity 

enrstaut <- enr[enr$ProjName=="Autopsy",]

enrstadclc <- enr[enr$ProjName=="ADCLC" & !is.na(enr$EnrolledDate),c("ID","EnrolledDate","RefusedDate","DeceasedDate","DroppedDate","LostDate")]
colnames(enrstadclc) <- c("ID","ADCLC_Enr_Date","ADCLC_Ref_Date","ADCLC_Dec_Date","ADCLC_Drop_Date","ADCLC_Lost_Date")

enrstaut <- merge(enrstaut,enrstadclc,by="ID")
enrstaut <- enrstaut[!is.na(enrstaut$ADCLC_Enr_Date),]

for (yr in 2001:cur_yr){
	lbl <- paste("Status_",yr,sep="")
	dt <- paste(yr,"-12-31",sep="")
	enrstaut[,lbl] <- ifelse(is.na(enrstaut$EnrolledDate),"Not_Enrolled",ifelse(!is.na(enrstaut$RefusedDate) & enrstaut$RefusedDate <= dt & enrstaut$RefusedDate >= enrstaut$EnrolledDate,"Refused",ifelse(!is.na(enrstaut$DroppedDate) & enrstaut$DroppedDate <= dt & enrstaut$DroppedDate >= enrstaut$EnrolledDate,"Dropped",ifelse(!is.na(enrstaut$DeceasedDate) & enrstaut$DeceasedDate <= dt & enrstaut$DeceasedDate >= enrstaut$EnrolledDate,"Deceased",ifelse(!is.na(enrstaut$LostDate) & enrstaut$LostDate <= dt & enrstaut$LostDate >= enrstaut$EnrolledDate,"Lost",ifelse(enrstaut$EnrolledDate <= dt,"Active",NA))))))	
}

for (yr in 2001:cur_yr){
	lbl <- paste("Status_LC_",yr,sep="")
	dt <- paste(yr,"-12-31",sep="")
	enrstaut[,lbl] <- ifelse(is.na(enrstaut$ADCLC_Enr_Date),"Not_Enrolled",ifelse(!is.na(enrstaut$ADCLC_Ref_Date) & enrstaut$ADCLC_Ref_Date <= dt & enrstaut$ADCLC_Ref_Date >= enrstaut$ADCLC_Enr_Date,"Refused",ifelse(!is.na(enrstaut$ADCLC_Drop_Date) & enrstaut$ADCLC_Drop_Date <= dt & enrstaut$ADCLC_Drop_Date >= enrstaut$ADCLC_Enr_Date,"Dropped",ifelse(!is.na(enrstaut$ADCLC_Dec_Date) & enrstaut$ADCLC_Dec_Date <= dt & enrstaut$ADCLC_Dec_Date >= enrstaut$ADCLC_Enr_Date,"Deceased",ifelse(!is.na(enrstaut$ADCLC_Lost_Date) & enrstaut$ADCLC_Lost_Date <= dt & enrstaut$ADCLC_Lost_Date >= enrstaut$ADCLC_Enr_Date,"Lost",ifelse(enrstaut$ADCLC_Enr_Date <= dt,"Active",NA))))))	
}

# for (yr in 2001:cur_yr){
# 	lbl <- paste("Status_LC_",yr,sep="")
# 	dt <- paste(yr,"-12-31",sep="")
# 	enrstaut[,lbl] <- ifelse(is.na(enrstaut$ADCLC_Enr_Date),"Not_Enrolled",ifelse(!is.na(enrstaut$ADCLC_Ref_Date) & enrstaut$ADCLC_Ref_Date <= dt & enrstaut$ADCLC_Ref_Date >= enrstaut$ADCLC_Enr_Date,"Refused",ifelse(!is.na(enrstaut$ADCLC_Drop_Date) & enrstaut$ADCLC_Drop_Date <= dt & enrstaut$ADCLC_Drop_Date >= enrstaut$ADCLC_Enr_Date,"Dropped",ifelse(!is.na(enrstaut$ADCLC_Dec_Date) & enrstaut$ADCLC_Dec_Date <= dt & enrstaut$ADCLC_Dec_Date >= enrstaut$ADCLC_Enr_Date,"Deceased",ifelse(!is.na(enrstaut$ADCLC_Lost_Date) & enrstaut$ADCLC_Lost_Date <= dt & enrstaut$ADCLC_Lost_Date >= enrstaut$ADCLC_Enr_Date,"Lost",ifelse(enrstaut$ADCLC_Enr_Date <= dt,"Active",NA))))))	
# }



#	Autopsy


dcat1 <- dcat[,c("ID","Ethnicity", "ADCLC_Status")]
enrstaut1 <- merge(enrstaut,dcat1,by="ID")
#	enrstaut1 <- enrstaut1[enrstaut1$ADCLC_Status=="Active",]
#	nrow(enrstaut1)
enrstaut1 <- enrstaut1[!is.na(enrstaut1$Ethnicity),]

#	enrstaut1[,c("ID","Ethnicity","Status_2001","Status_2002","Status_2003","Status_2004", "Status_2005","Status_2006","Status_2007","Status_2008","Status_2009","Status_2010","Status_2011","Status_2012", "Status_2013","Status_2014")]

cnmsta <- sapply(2001:cur_yr, function(x) paste("Status_LC_",x,sep=""))
enrstaut2 <- data.frame(enrstaut1[,c("ID","Ethnicity")], stack(enrstaut1[,cnmst]), stack(enrstaut1[,cnmsta]), row.names=NULL)

# enrstaut2 <- data.frame(enrstaut1[,c("ID","Ethnicity")], stack(enrstaut1[,c("Status_2001","Status_2002","Status_2003","Status_2004", "Status_2005","Status_2006","Status_2007","Status_2008","Status_2009","Status_2010","Status_2011","Status_2012", "Status_2013","Status_2014")]), stack(enrstaut1[,c("Status_LC_2001","Status_LC_2002","Status_LC_2003","Status_LC_2004", "Status_LC_2005","Status_LC_2006","Status_LC_2007","Status_LC_2008","Status_LC_2009","Status_LC_2010","Status_LC_2011","Status_LC_2012", "Status_LC_2013","Status_LC_2014")]))

enrstaut2 <- enrstaut2[with(enrstaut2,order(ID)),]

enrstaut2$year <- substr(enrstaut2$ind,8,11)
enrstaut2 <- enrstaut2[!is.na(enrstaut2$values) & !is.na(enrstaut2$values.1),]
enrstaut2 <- enrstaut2[enrstaut2$values.1=="Active",]

enrstlc2 <- enrstaut2

enrstaut2 <- enrstaut2[enrstaut2$values=="Active",]
#	table(enrstaut2$values)

enrstaut3 <- ddply(enrstaut2, .(Ethnicity, year), summarise,
	N = length(ID))
	

enrstaut4 <- ddply(enrstaut3, .(year), summarise, 
	African_American.Aut.N = sum(ifelse(Ethnicity==4,N,0)),
	Hispanic.Aut.N = sum(ifelse(Ethnicity==6, N,0)),
	White.Aut.N = sum(ifelse(Ethnicity==7, N,0)),
	Other.Aut.N = sum(ifelse(Ethnicity %in% c(1,2,3,5,8), N,0))
	)
	
enrstaut4$Total_Aut <- enrstaut4$African_American.Aut.N + enrstaut4$Hispanic.Aut.N + enrstaut4$White.Aut.N + enrstaut4$Other.Aut.N	

#	ADCLC 


enrstlc3 <- ddply(enrstlc2, .(Ethnicity, year), summarise,
	N = length(ID))
	

enrstlc4 <- ddply(enrstlc3, .(year), summarise, 
	African_American.ADCLC.N = sum(ifelse(Ethnicity==4,N,0)),
	Hispanic.ADCLC.N = sum(ifelse(Ethnicity==6, N,0)),
	White.ADCLC.N = sum(ifelse(Ethnicity==7, N,0)),
	Other.ADCLC.N = sum(ifelse(Ethnicity %in% c(1,2,3,5,8), N,0))
	)
	
enrstlc4$Total_LC <- enrstlc4$African_American.ADCLC.N + enrstlc4$Hispanic.ADCLC.N + enrstlc4$White.ADCLC.N + enrstlc4$Other.ADCLC.N	

enrstaut4 <- merge(enrstaut4,enrstlc4,by="year")

enrstaut4$Afr_Am_Pct_Aut <- (enrstaut4$African_American.Aut.N / enrstaut4$African_American.ADCLC.N) * 100
enrstaut4$Hisp_Pct_Aut <- (enrstaut4$Hispanic.Aut.N / enrstaut4$Hispanic.ADCLC.N) * 100
enrstaut4$White_Pct_Aut <- (enrstaut4$White.Aut.N / enrstaut4$White.ADCLC.N) * 100
enrstaut4$Total_Pct_Aut <- (enrstaut4$Total_Aut / enrstaut4$Total_LC) * 100
	
```

#### Total ADCC Enrollment (10-91 to present) by race, ethnicity, and gender

```{r, label=adcc_enroll_tot, results="asis", warning=FALSE, echo=FALSE}
enrrpta <- dcat[,c("ID","DtIA","GENDER","Ethnicity","RACE","HISPANIC","ADCLC_Enroll")]
enrrpta$DtIA <- as.Date(enrrpta$DtIA)
enrrpta <- enrrpta[(enrrpta$DtIA >= "1991-10-01" & enrrpta$DtIA < "2005-09-01") |
      (enrrpta$DtIA >= "1991-10-01" & enrrpta$ADCLC_Enroll %in% "Enrolled"),]

enrrpta <-  enrrpta[!is.na(enrrpta$GENDER),]
enrrpta$Gender <- factor(enrrpta$GENDER, 
         labels=c("Male",
                  "Female"))

enrrpta$Hispanic <- ifelse(!is.na(enrrpta$HISPANIC),enrrpta$HISPANIC,
        ifelse(enrrpta$Ethnicity %in% 6,1,
        ifelse(enrrpta$Ethnicity %in% c(1,2,3,4,5,7,8),0,
        ifelse(enrrpta$Ethnicity %in% 9,9,
        9))))

enrrpta$Hispanic <- ifelse(enrrpta$Hispanic %in% c(-6,-7,-9),9,enrrpta$Hispanic)
enrrpta$Hispanic <- factor(enrrpta$Hispanic, 
         labels=c("Not Hispanic",
                  "Hispanic",
                  "Not Determined"))


enrrpta$Race <- ifelse(!is.na(enrrpta$RACE),enrrpta$RACE,
          ifelse(enrrpta$Ethnicity %in% 7,1,
          ifelse(enrrpta$Ethnicity %in% 4,2,
          ifelse(enrrpta$Ethnicity %in% 1,3,
          ifelse(enrrpta$Ethnicity %in% c(3,5),4,
          ifelse(enrrpta$Ethnicity %in% 2,5,
          ifelse(enrrpta$Ethnicity %in% 8,50,
          ifelse(enrrpta$Ethnicity %in% 6,99,
          ifelse(enrrpta$Ethnicity %in% 9,99,
          99)))))))))

enrrpta$Race <- ifelse(enrrpta$Race %in% c(-6,-7,-9),99,enrrpta$Race)
enrrpta$Race <- factor(enrrpta$Race, 
         labels=c("White",
                  "Black",
                  "American Indian/Native Alaskan",
                  "Hawaiian/Pacific Islander",
                  "Asian",
                  "Other",
                  "Not Determined"))

enrrpta$hisppres <- ifelse(is.na(enrrpta$Hispanic),2,1)
enrrpta$hisppres <- factor(enrrpta$hisppres, 
         labels=c("All Ethnicity"))

enrrpta$racepres <- ifelse(is.na(enrrpta$Race),2,1)
enrrpta$racepres <- factor(enrrpta$racepres, 
         labels=c("All Race"))

# table(enrrpta$Race)
# table(enrrpta$RACE)
# table(enrrpta$Ethnicity)
# table(enrrpta$Ethnicity,enrrpta$RACE)
# table(enrrpta$Hispanic)
# table(enrrpta$hisppres)
# table(enrrpta$HISPANIC)

table_data <- list()
 
# Get the basic stats
table_data[["Ethnic Category"]] <- getT1Stat("Hispanic","Gender",enrrpta)
table_data[["Ethnic Category - Total"]] <- getT1Stat("hisppres","Gender",enrrpta)
table_data[["Racial Categories"]] <- getT1Stat("Race","Gender",enrrpta)
table_data[["Racial Categories - Total"]] <- getT1Stat("racepres","Gender",enrrpta)

#  generate output data for table
out_data <- descStatTable(table_data)
out_data$output_data <- out_data$output_data[,c(3,2,1)]

cgroup <- c("Sex/Gender","")
n.cgroup <- c(2,1)

#	generate latex code for table
# latex(out_data$output_data,
#           rgroup=out_data$rgroup, n.rgroup=out_data$n.rgroup, 
#         file="", title="",caption="Characteristics of  longitudinal sample with 2+ SENAS or IVD evaluations by baseline diagnosis.",
#         label="adclc_anal_dx_2",booktabs=TRUE, where="!htbp",longtable=TRUE,cgroup=cgroup,n.cgroup=n.cgroup)   

# generate html code for table
htmlTable(out_data$output_data, align="rrr",
          rgroup=out_data$rgroup, n.rgroup=out_data$n.rgroup, 
          # rgroupCSSseparator="", 
          cgroup = cgroup,
          n.cgroup = n.cgroup,
          rowlabel="", 
          ctable=TRUE)

```

#### Hispanic Enrollment - Total ADCC Enrollment (10-91 to present) by race and gender

```{r, label=adcc_enroll_tot_hisp, results="asis", warning=FALSE, echo=FALSE}
enrrpth <- enrrpta[enrrpta$Hispanic %in% "Hispanic",]

table_data <- list()
 
# Get the basic stats
table_data[["Racial Categories"]] <- getT1Stat("Race","Gender",enrrpth)
table_data[["Racial Categories - Total"]] <- getT1Stat("racepres","Gender",enrrpth)

# table_data <- tableBalance(table_data)

#  generate output data for table
out_data <- descStatTable(table_data)
out_data$output_data <- out_data$output_data[,c(3,2,1)]

cgroup <- c("Sex/Gender","")
n.cgroup <- c(2,1)

#  generate latex code for table
# latex(out_data$output_data,
#           rgroup=out_data$rgroup, n.rgroup=out_data$n.rgroup, 
#         file="", title="",caption="Characteristics of  longitudinal sample with 2+ SENAS or IVD evaluations by baseline diagnosis.",
#         label="adclc_anal_dx_2",booktabs=TRUE, where="!htbp",longtable=TRUE,cgroup=cgroup,n.cgroup=n.cgroup)   

# generate html code for table
htmlTable(out_data$output_data, align="rrr",
          rgroup=out_data$rgroup, n.rgroup=out_data$n.rgroup, 
          # rgroupCSSseparator="", 
          cgroup = cgroup,
          n.cgroup = n.cgroup,
          rowlabel="", 
          ctable=TRUE)

```

#### Current Grant Cycle ADCC Enrollment (07-16 to present) by race, ethnicity, and gender

```{r, label=adcc_enroll_cur, results="asis", warning=FALSE, echo=FALSE}
# enrrptc <- enrrpta[enrrpta$DtIA >= "2015-04-01" & enrrpta$DtIA <= "2017-04-30",]
enrrptc <- enrrpta[enrrpta$DtIA >= "2016-07-01",]
table_data <- list()
 
# Get the basic stats
table_data[["Ethnic Category"]] <- getT1Stat("Hispanic","Gender",enrrptc)
table_data[["Ethnic Category - Total"]] <- getT1Stat("hisppres","Gender",enrrptc)
table_data[["Racial Categories"]] <- getT1Stat("Race","Gender",enrrptc)
table_data[["Racial Categories - Total"]] <- getT1Stat("racepres","Gender",enrrptc)

#  generate output data for table
out_data <- descStatTable(table_data)
out_data$output_data <- out_data$output_data[,c(3,2,1)]

cgroup <- c("Sex/Gender","")
n.cgroup <- c(2,1)

#  generate latex code for table
# latex(out_data$output_data,
#           rgroup=out_data$rgroup, n.rgroup=out_data$n.rgroup, 
#         file="", title="",caption="Characteristics of  longitudinal sample with 2+ SENAS or IVD evaluations by baseline diagnosis.",
#         label="adclc_anal_dx_2",booktabs=TRUE, where="!htbp",longtable=TRUE,cgroup=cgroup,n.cgroup=n.cgroup)   

# generate html code for table
htmlTable(out_data$output_data, align="rrr",
          rgroup=out_data$rgroup, n.rgroup=out_data$n.rgroup, 
          # rgroupCSSseparator="", 
          cgroup = cgroup,
          n.cgroup = n.cgroup,
          rowlabel="", 
          ctable=TRUE)

```

#### Hispanic Enrollment - Current Grant Cycle ADCC Enrollment (07-16 to present) by race and gender

```{r, label=adcc_enroll_cur_hisp, results="asis", warning=FALSE, echo=FALSE}
enrrptc <- enrrptc[enrrptc$Hispanic %in% "Hispanic",]

table_data <- list()
 
# Get the basic stats
table_data[["Racial Categories"]] <- getT1Stat("Race","Gender",enrrptc)
table_data[["Racial Categories - Total"]] <- getT1Stat("racepres","Gender",enrrptc)

# table_data <- tableBalance(table_data)

#  generate output data for table
out_data <- descStatTable(table_data)
out_data$output_data <- out_data$output_data[,c(3,2,1)]

cgroup <- c("Sex/Gender","")
n.cgroup <- c(2,1)

#  generate latex code for table
# latex(out_data$output_data,
#           rgroup=out_data$rgroup, n.rgroup=out_data$n.rgroup, 
#         file="", title="",caption="Characteristics of  longitudinal sample with 2+ SENAS or IVD evaluations by baseline diagnosis.",
#         label="adclc_anal_dx_2",booktabs=TRUE, where="!htbp",longtable=TRUE,cgroup=cgroup,n.cgroup=n.cgroup)   

# generate html code for table
htmlTable(out_data$output_data, align="rrr",
          rgroup=out_data$rgroup, n.rgroup=out_data$n.rgroup, 
          # rgroupCSSseparator="", 
          cgroup = cgroup,
          n.cgroup = n.cgroup,
          rowlabel="", 
          ctable=TRUE)

```

#### New enrollment in the ADC longitudinal cohort by race/ethnicity and year


```{r, label=enr_adclc_yr_eth, fig=TRUE, warning=FALSE, echo=FALSE}

#	ADCLC Enrollment

par(new=FALSE)
plot(enr6$Total ~ enr6$YearEnr,xlim = c(1991,cur_yr), ylim = c(0,170), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year of Enrollment", ylab = "Number Enrolled", lty=1, lwd=2.5, col = col_names[1])
par(new=TRUE)
plot(enr6$African_American.ADCLC.N ~ enr6$YearEnr,xlim = c(1991,cur_yr), ylim = c(0,170), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year of Enrollment", ylab = "Number Enrolled",main="", lty=1, lwd=2.5, col = col_names[2])
par(new= TRUE)
plot(enr6$Hispanic.ADCLC.N ~ enr6$YearEnr,xlim = c(1991,cur_yr), ylim = c(0,170), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year of Enrollment", ylab = "Number Enrolled",main="", lty=1, lwd=2.5, col = col_names[3])
par(new= TRUE)
plot(enr6$White.ADCLC.N ~ enr6$YearEnr,xlim = c(1991,cur_yr), ylim = c(0,170), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year of Enrollment", ylab = "Number Enrolled",main="", lty=1, lwd=2.5, col = col_names[4])

legend("topright",inset = .00, c('Total','African American','Hispanic','White'), lty = c(1,1,1,1), col=c(col_names[1], col_names[2], col_names[3], col_names[4]),lwd = 2.5,box.col=0,cex=1.0)

```

#### New enrollment in the ADC longitudinal cohort by race/ethnicity and year (Table)


```{r, results="asis", warning=FALSE, echo=FALSE}

tabout <- enr6
names(tabout) <- c("Year","African American","Hispanic","White",
      "Other","Total")
# pandoc.table(tabout,justify='lccccc')
htmlTable(tabout,
          align = "cccccc",
          header = c("Year  A", "frican American  H","ispanic  W","hite  O", "ther  T","otal"),
          rnames=FALSE,
          ctable = TRUE)


```

#### New enrollment in the Diversity cohort by race/ethnicity and year

```{r, label=enr_c2_yr_eth, fig=TRUE,width=7.5,height=5.0, warning=FALSE, message=FALSE, echo=FALSE}

#	C2 Enrollment

par(new=FALSE)
plot(enr5$Total ~ enr5$YearEnr,xlim = c(2001,cur_yr), ylim = c(0,120), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year of Enrollment", ylab = "Number Enrolled",lty=1, lwd=2.5, col = col_names[1])
par(new=TRUE)
plot(enr5$African_American.C2.N ~ enr5$YearEnr,xlim = c(2001,cur_yr), ylim = c(0,120), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year of Enrollment", ylab = "Number Enrolled",main="", lty=1, lwd=2.5, col = col_names[2])
par(new= TRUE)
plot(enr5$Hispanic.C2.N ~ enr5$YearEnr,xlim = c(2001,cur_yr), ylim = c(0,120), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year of Enrollment", ylab = "Number Enrolled",main="", lty=1, lwd=2.5, col = col_names[3])
par(new= TRUE)
plot(enr5$White.C2.N ~ enr5$YearEnr,xlim = c(2001,cur_yr), ylim = c(0,120), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year of Enrollment", ylab = "Number Enrolled",main="", lty=1, lwd=2.5, col = col_names[4])

legend("topright",inset = 0.0, c('Total','African American','Hispanic','White'), lty = c(1,1,1,1), col=c(col_names[1], col_names[2], col_names[3], col_names[4]),lwd = 2.5,box.col=0,cex=1.0)

grid(nx=NA,ny=NULL,lwd=2)

```

*****
#### Number actively enrolled in the ADC longitudinal cohort by race/ethnicity and year 

```{r,label=active_adclc_yr_eth, fig=TRUE, echo=FALSE}

#	ADCLC Active

par(new=FALSE)
plot(enrst4$Total ~ enrst4$year,xlim = c(2001,cur_yr), ylim = c(0,800), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year", ylab = "Number Active", lty=1, lwd=2.5, col = col_names[1])
par(new=TRUE)
plot(enrst4$African_American.ADCLC.N ~ enrst4$year,xlim = c(2001,cur_yr), ylim = c(0,800), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year", ylab = "Number Active",main="", lty=1, lwd=2.5, col = col_names[2])
par(new= TRUE)
plot(enrst4$Hispanic.ADCLC.N ~ enrst4$year,xlim = c(2001,cur_yr), ylim = c(0,800), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year", ylab = "Number Active",main="", lty=1, lwd=2.5, col = col_names[3])
par(new= TRUE)
plot(enrst4$White.ADCLC.N ~ enrst4$year,xlim = c(2001,cur_yr), ylim = c(0,800), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year", ylab = "Number Active",main="", lty=1, lwd=2.5, col = col_names[4])

legend("topright",inset = .00, c('Total','African American','Hispanic','White'), lty = c(1,1,1,1), col=c(col_names[1], col_names[2], col_names[3], col_names[4]),lwd = 2.5,box.col=0,cex=1.0)

grid(nx=NA,ny=NULL,lwd=2)
```

****

#### Number actively enrolled in the Diversity cohort by race/ethnicity and year. Includes enrollees in a different cohort who were later transferred to the Diversity cohort


```{r, label=active_c2_yr_eth, fig=TRUE, echo=FALSE}

par(new=FALSE)
plot(enrstc24$Total ~ enrstc24$year,xlim = c(2001,cur_yr), ylim = c(0,700), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year", ylab = "Number Active", lty=1, lwd=2.5, col = col_names[1])
par(new=TRUE)
plot(enrstc24$African_American.C2.N ~ enrstc24$year,xlim = c(2001,cur_yr), ylim = c(0,700), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year", ylab = "Number Active",main="", lty=1, lwd=2.5, col = col_names[2])
par(new= TRUE)
plot(enrstc24$Hispanic.C2.N ~ enrstc24$year,xlim = c(2001,cur_yr), ylim = c(0,700), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year", ylab = "Number Active",main="", lty=1, lwd=2.5, col = col_names[3])
par(new= TRUE)
plot(enrstc24$White.C2.N ~ enrstc24$year,xlim = c(2001,cur_yr), ylim = c(0,700), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year", ylab = "Number Active",main="", lty=1, lwd=2.5, col = col_names[4])

legend("topright",inset = .00, c('Total','African American','Hispanic','White'), lty = c(1,1,1,1), col=c(col_names[1], col_names[2], col_names[3], col_names[4]),lwd = 2.5,box.col=0,cex=1.0)

grid(nx=NA,ny=NULL,lwd=2)
```

#### Number actively enrolled in the Diversity cohort by race/ethnicity and year. Excludes enrollees in a different cohort who were later transferred to the Diversity cohort.

```{r, label=active_c2_yr_eth_nt, fig=TRUE,echo=FALSE}

#	C2 Active without transfers

par(new=FALSE)
plot(enrstc2t4$Total ~ enrstc2t4$year,xlim = c(2001,cur_yr), ylim = c(0,700), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year", ylab = "Number Active", lty=1, lwd=2.5, col = col_names[1])
par(new=TRUE)
plot(enrstc2t4$African_American.C2.N ~ enrstc2t4$year,xlim = c(2001,cur_yr), ylim = c(0,700), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year", ylab = "Number Active",main="", lty=1, lwd=2.5, col = col_names[2])
par(new= TRUE)
plot(enrstc2t4$Hispanic.C2.N ~ enrstc2t4$year,xlim = c(2001,cur_yr), ylim = c(0,700), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year", ylab = "Number Active",main="", lty=1, lwd=2.5, col = col_names[3])
par(new= TRUE)
plot(enrstc2t4$White.C2.N ~ enrstc2t4$year,xlim = c(2001,cur_yr), ylim = c(0,700), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year", ylab = "Number Active",main="", lty=1, lwd=2.5, col = col_names[4])

legend("topright",inset = .00, c('Total','African American','Hispanic','White'), lty = c(1,1,1,1), col=c(col_names[1], col_names[2], col_names[3], col_names[4]),lwd = 2.5,box.col=0,cex=1.0)

grid(nx=NA,ny=NULL,lwd=2)
```

*****

## Longitudinal Cohort Initial and Follow-up Evaluations   


```{r, label=eval_hx_prelim, message=FALSE, echo=FALSE}

# library(dplyr)
# library(tidyr)

# colnames(asl1) <- gsub("idal","ID",colnames(asl1))
# asl1$ID <- as.numeric(asl1$ID)
# asl1$VDate <- as.Date(asl1$VDate)

asl1$AssessListID <- 1:nrow(asl1)
asl1 <- asl1[!is.na(asl1$VisitNum),]
asl2 <- asl1[!is.na(asl1$VisitType) | (is.na(asl1$VisitType) & asl1$VisitStatus %in% c("CAME IN","COMPLETE")),]
# asl1[asl1$ID %in% 2893,]
# asl2[asl2$ID %in% 2893,]
asl2 <- asl1 %>% group_by(ID) %>%
  summarise(
    min_assess_list_id = min(AssessListID)
  )

asl1 <- merge(asl1,asl2,by="ID")
asl1$asn <- asl1$AssessListID - asl1$min_assess_list_id + 1

asl4 <- asl1[,c("ID","asn","VDate","VisitType")]
colnames(asl4) <- gsub("VDate","vdt_next",colnames(asl4))
colnames(asl4) <- gsub("VisitType","vtyp_next",colnames(asl4))

asl4$asn <- asl4$asn-1


asl <- merge(asl1[,c("ID","AssessListID","asn","VDate","VisitType","LastOfficeEval")], asl4[,c("ID","asn","vdt_next","vtyp_next")], by=c("ID","asn"),all.x=TRUE)

rm(asl2,asl4)

vlist <- c("Home","Phone","Lost","Refused","No Longer Followed","Deceased","Other")

asl <- asl[!asl$VisitType %in% vlist,]

asl$time_betw <- as.numeric((asl$vdt_next - asl$VDate) / 365.25)

asl$year <- as.numeric(format(asl$vdt_next, "%Y"))
asl$month <- as.numeric(format(asl$vdt_next, "%m"))
asl$monthl <- format(asl$vdt_next, "%b")

# requires dcat from main program

dcat1 <- dcat[,c("ID","Ethnicity", "Cohort", "center","ADCLC_Status","ADCLC_Enroll","DtLastEval")]

dcat1$time_last <- as.numeric(((as.Date(date(), format="%a %b %d %H:%M:%S %Y") - dcat1$DtLastEval)/365.25))
dcat1$year_last <- as.factor(format(dcat1$DtLastEval, "%Y"))


asl <- merge(asl,dcat1,by="ID")

asl1$year <- as.numeric(format(asl1$VDate, "%Y"))
asl1$month <- as.numeric(format(asl1$VDate, "%m"))
asl1$monthl <- format(asl1$VDate, "%b")

asl1 <- merge(asl1,dcat1[,c("ID","Cohort","ADCLC_Enroll","ADCLC_Status"),], by="ID")

```

#### Number of initial evaluations by year for enrollees in the ADC longitudinal cohort

```{r, label=n_ia_by_year, fig=TRUE,echo=FALSE}

noff1 <- group_by(asl1[asl1$VisitType == "Office" & asl1$FirstEval == "Yes" & asl1$ADCLC_Enroll == "Enrolled",], year)
noffc <- summarise(noff1,
                    n_office_vis = n())

noff1 <- group_by(asl1[asl1$VisitType == "Office" & asl1$ID >= 50000 & asl1$FirstEval == "Yes" & asl1$ADCLC_Enroll == "Enrolled",], year)
noffe <- summarise(noff1,
                   n_office_vis = n())

noff1 <- group_by(asl1[asl1$VisitType == "Office" & asl1$ID < 50000 & asl1$FirstEval == "Yes" & asl1$ADCLC_Enroll == "Enrolled",], year)
noffs <- summarise(noff1,
                   n_office_vis = n())

plot(n_office_vis ~ year, data=noffc, type="n",pch=1, xlim=c(2001,cur_yr), ylim=c(0,200), xlab="Year", ylab="Number of Evaluations")
lines(n_office_vis ~ year, data=noffc, type="l",col="red",lwd=2)
lines(n_office_vis ~ year, data=noffe, type="l",col="blue",lwd=2)
lines(n_office_vis ~ year, data=noffs, type="l",col="green",lwd=2)

legend("topleft",c("ADC Combined","East Bay","Sacramento"), lty=1, col=c("red","blue","green"),bty="n", lwd=2)

grid(nx=NA,ny=NULL,lwd=2)

rm(noff1)

```


#### Number of follow-up evaluations by year for enrollees in the ADC longitudinal cohort

```{r, label=n_ra_by_year, fig=TRUE,echo=FALSE}

noff2 <- group_by(asl1[asl1$VisitType == "Office" & !asl1$FirstEval %in% "Yes" & asl1$ADCLC_Enroll == "Enrolled",], year)
noff2c <- summarise(noff2,
                   n_office_vis = n())

noff2 <- group_by(asl1[asl1$VisitType == "Office" & asl1$ID >= 50000 & !asl1$FirstEval %in% "Yes" & asl1$ADCLC_Enroll == "Enrolled",], year)
noff2e <- summarise(noff2,
                   n_office_vis = n())

noff2 <- group_by(asl1[asl1$VisitType == "Office" & asl1$ID < 50000 & !asl1$FirstEval %in% "Yes" &  asl1$ADCLC_Enroll == "Enrolled",], year)
noff2s <- summarise(noff2,
                   n_office_vis = n())

plot(n_office_vis ~ year, data=noff2c, type="n",pch=1, main="",xlim=c(2001,cur_yr), ylim=c(0,700), xlab="Year", ylab="Number of Evaluations")
lines(n_office_vis ~ year, data=noff2c, type="l",col="red",lwd=2)
lines(n_office_vis ~ year, data=noff2e, type="l",col="blue",lwd=2)
lines(n_office_vis ~ year, data=noff2s, type="l",col="green",lwd=2)

legend("topleft",c("ADC Combined","East Bay","Sacramento"), lty=1, col=c("red","blue","green"),bty="n", lwd=2)

grid(nx=NA,ny=NULL,lwd=2)

rm(noff2)

```

*****

#### Number of evaluations by month, last 36 months

```{r, label=n_eval_by_month, results="asis", echo=FALSE}

#   asl2 <- filter(asl1, VisitType == "Office" & ADCLC_Enroll == "Enrolled" & (as.Date(date(), format="%a %b %d %H:%M:%S %Y") - VDate) < 1095) %>%
#   mutate(site = ifelse(ID >= 50000, "East_Bay", "Sacramento"), type = ifelse(!is.na(FirstEval) & FirstEval == "Yes", "Initial", "Follow-Up"))

asl2 <- filter(asl1, ((VisitType == "Office" & VisitStatus %in% c("CAME IN","COMPLETE")) | (is.na(VisitType) & VisitStatus %in% c("CAME IN","COMPLETE"))) & ADCLC_Enroll == "Enrolled" & (as.Date(date(), format="%a %b %d %H:%M:%S %Y") - VDate) < 1095) %>%
mutate(site = ifelse(ID >= 50000, "East_Bay", "Sacramento"), type = ifelse(!is.na(FirstEval) & FirstEval == "Yes", "Initial", "Follow-Up"))

# asl2 <- filter(asl1, (VisitType == "Office" | (is.na(VisitType) & VisitStatus %in% c("CAME IN","COMPLETE"))) & ADCLC_Enroll == "Enrolled" & (as.Date(date(), format="%a %b %d %H:%M:%S %Y") - VDate) < 1095) %>%
# mutate(site = ifelse(ID >= 50000, "East_Bay", "Sacramento"), type = ifelse(!is.na(FirstEval) & FirstEval == "Yes", "Initial", "Follow-Up"))
  
noff <-  select(asl2, month, monthl, year, site, type) %>% group_by(monthl, year, site, type) %>%
  summarise(n_office_vis = n(), month = min(month)) %>%
  arrange(type, site, year, month, monthl) %>%
  mutate(mnthyr = paste(monthl,"-",year,sep=""))
#  mutate(mnthyr = paste(sprintf("%02d",month),",",year,sep=" "))

noffu <- unique(noff[,c("year", "month", "mnthyr")])
noffu <- noffu[order(noffu$year, noffu$month),]
noffu$mnthseq <- 1:nrow(noffu)
noff <- merge(noff,noffu[,-3],by=c("year","month"),all.x=TRUE)
# noff$mnthyr2 <- as.factor(noff$level)
# noff$mnthyr <- factor(noff$mnthyr , levels = noffu[order(noffu$year, noffu$month),"mnthyr"])


rm(asl2, noffu)

ini <- filter(noff, type == "Initial") %>%
  select(site, n_office_vis, mnthseq, mnthyr)  %>%
  spread(site, n_office_vis) %>%
  mutate(Combined = ifelse(is.na(East_Bay),0,East_Bay) + ifelse(is.na(Sacramento),0,Sacramento))

fu <- filter(noff, type == "Follow-Up") %>%
  select(site, n_office_vis, mnthseq, mnthyr)  %>%
  spread(site, n_office_vis) %>%
  mutate(Combined = ifelse(is.na(East_Bay),0,East_Bay) + ifelse(is.na(Sacramento),0,Sacramento))

visout <- merge(ini[,1:5],fu[,1:5],by=c("mnthseq","mnthyr"),all=TRUE)
visout <- visout[order(visout$mnthseq),]
visout <- visout[,c("mnthyr","East_Bay.x","Sacramento.x","Combined.x","East_Bay.y","Sacramento.y","Combined.y")]

rownames(visout) <- visout$mnthyr
visout <- visout[, 2:7]

htmlTable(visout,
          align = "cccccc",
          cgroup=c("Initial", "Follow-Up"), n.cgroup=c(3,3), 
          rowlabel="Month",
          header = c("East Bay S", "acramento C","ombined","East Bay S", "acramento C","ombined"),
          ctable = TRUE)


# The following section will display month horizontally
# table_data_evals <- list()
# 
# noff1 <- noff[noff$type == "Initial",]
# table_data_evals[["Initial Evaluations"]] <- xtabs(n_office_vis ~ site + mnthyr, data = noff1)
# noff2 <- noff[noff$type == "Follow-Up",]
# table_data_evals[["Follow-ups"]] <- xtabs(n_office_vis ~ site + mnthyr, data =noff2)
# 
# out_data_evals <- descStatTable(table_data_evals)
# # out_data_evals$output_data <- out_data_evals$output_data[,c(2:ncol(out_data_evals$output_data),1)]
# 
# htmlTable(out_data_evals$output_data,
#           rgroup=out_data_evals$rgroup, n.rgroup=out_data_evals$n.rgroup, 
#           rgroupCSSseparator="", 
#           rowlabel="", 
#           caption="Number of initial and follow-up evaluations of enrollees in ADC longitudinal cohort.", 
#           # tfoot="<sup>a</sup> Also known as Breslow thickness", 
#           ctable=TRUE)

```


*****

## Longitudinal Follow-up and Retention

### Follow-up intervals


```{r, label=enr_surv_prelim, echo=FALSE}

eth <- ensur

eth$status <- ifelse(eth$CensorNLF==0,1,ifelse(eth$CensorNLF ==1,0,NA))
eth$status7 <- ifelse(eth$Censor7NLF==0,1,ifelse(eth$Censor7NLF ==1,0,NA))
eth$time7 <- ifelse(eth$time2NLF > 7, 7, eth$time2NLF)
eth$statusd <- ifelse(eth$CensorDeath==0,1,ifelse(eth$CensorDeath ==1,0,NA))
eth$status7d <- ifelse(eth$Censor7Death==0,1,ifelse(eth$Censor7Death ==1,0,NA))
eth$time7d <- ifelse(eth$time2Death > 7, 7, eth$time2Death)

eth$status9 <- ifelse(eth$Censor9NLF==0,1,ifelse(eth$Censor9NLF ==1,0,NA))
eth$time9 <- ifelse(eth$time2NLF > 10, 10, eth$time2NLF)
eth$status9d <- ifelse(eth$Censor9Death==0,1,ifelse(eth$Censor9Death ==1,0,NA))
eth$time9d <- ifelse(eth$time2Death > 10, 10, eth$time2Death)



ethc2 <- eth[eth$Cohort == "C2" | eth$Cohort == "C2/Hillblom" | eth$Cohort == "Hillblom",]
ethe <- eth[(eth$Cohort == "C2" | eth$Cohort == "C2/Hillblom" | eth$Cohort == "Hillblom") & eth$center=="East_Bay",]
eths <- eth[(eth$Cohort == "C2" | eth$Cohort == "C2/Hillblom" | eth$Cohort == "Hillblom") & eth$center=="Sacramento",]

leg1 <- c("Demented","MCI","Normal")
leg2 <- c("African American","Hispanic","White")
leg3 <- c("Clinic","Community")
leg4 <- c("0-11","12","13-16","17+")



```

#### Number of evaluations by time from initial evaluation for ADC longitudinal cohort participants by year (completed evaluations)

```{r, label=adclc_fu_time_num, fig=TRUE, echo=FALSE}
# require(lattice)

aslfu <- asl1[asl1$VisitType %in% "Office",c("ID","VDate","VisitType","ADCLC_Enroll")]
aslfu <- aslfu[order(aslfu$ID,aslfu$VDate),]
aslfu$rnum <- 1:nrow(aslfu)

evalmin <- group_by(aslfu, ID) %>%
            summarise(min_dt = min(VDate),
                      min_rnum = min(rnum))

aslfu <- merge(aslfu,evalmin,by="ID", all.x=TRUE)

aslfu$first_eval <- ifelse(aslfu$min_dt == aslfu$VDate,1,0)
aslfu$time_fu <- as.numeric((aslfu$VDate - aslfu$min_dt) / 365.25)
aslfu$assess_num <- aslfu$rnum - aslfu$min_rnum
aslfu$year <- as.factor(as.numeric(format(aslfu$VDate, "%Y")))

aslfugr <- aslfu[aslfu$year %in% (cur_yr-11):cur_yr & aslfu$ADCLC_Enroll %in% "Enrolled",]

xyplot( assess_num ~ time_fu | year, data=aslfugr,
        panel = function(x, y, groups, subscripts, ...) {
          panel.xyplot(x, y, type = c("p","r"),col="blue", col.line="blue", lwd=2)
          panel.abline(coef=c(0,1), col.line="red", lwd=2)
        })

```

#### Time between completed clinical evaluations of ADC longitudinal cohort participants by year

```{r, label=adclc_fu_interval_bw, fig=TRUE, echo=FALSE}

asl5 <- asl[asl$ADCLC_Enroll %in% "Enrolled",]
boxplot(asl5$time_betw ~ asl5$year, col="red",outcol="blue",whiskcol="blue",staplecol="blue",medcol="blue",boxcol="blue")

# t1 <- asl5[!is.na(asl5$time_betw) & asl5$time_betw > 10,]

```

****

#### Average time by year between completed clinical evaluations \n of participants in the ADC longitudinal cohort


```{r, label=adclc_fu_interval_mn, fig=TRUE,echo=FALSE}

asl6 <- group_by(asl5, year)
asl7 <- summarise(asl6,
                  mean_time_between = mean(time_betw),
                  median_time_between = median(time_betw))

asl5e <- asl[asl$ADCLC_Enroll == "Enrolled" & asl$center == "East_Bay",]
asl6e <- group_by(asl5e, year)
asl7e <- summarise(asl6e,
                  mean_time_between = mean(time_betw),
                  median_time_between = median(time_betw))

asl5s <- asl[asl$ADCLC_Enroll == "Enrolled" & asl$center == "Sacramento",]
asl6s <- group_by(asl5s, year)
asl7s <- summarise(asl6s,
                  mean_time_between = mean(time_betw),
                  median_time_between = median(time_betw))

plot(mean_time_between ~ year, data=asl7, type="n",pch=1, xlim=c(2001,cur_yr), ylim=c(0.8,2.5),xlab="Year", ylab = "Average Time Between Evaluations")
lines(mean_time_between ~ year, data=asl7, type="l",col="red",lwd=2)
lines(mean_time_between ~ year, data=asl7e, type="l",col="blue",lwd=2)
lines(mean_time_between ~ year, data=asl7s, type="l",col="green",lwd=2)

legend("topleft",c("ADC Combined","East Bay","Sacramento"), lty=1, col=c("red","blue","green"),bty="n", lwd=2)

grid(nx=NA,ny=NULL,lwd=2)

rm(asl5,asl6,asl5e,asl6e,asl5s,asl6s)
```

#### Median time by year between completed clinical evaluations \n of participants in the ADC longitudinal cohort


```{r, label=adclc_fu_interval_mdn, fig=TRUE,echo=FALSE}

plot(median_time_between ~ year, data=asl7, type="n",pch=1, xlim=c(2001,cur_yr), ylim=c(0.8,2.5),xlab="Year", ylab = "Median Time Between Evaluations")
lines(median_time_between ~ year, data=asl7, type="l",col="red",lwd=2)
lines(median_time_between ~ year, data=asl7e, type="l",col="blue",lwd=2)
lines(median_time_between ~ year, data=asl7s, type="l",col="green",lwd=2)

legend("topleft",c("ADC Combined","East Bay","Sacramento"), lty=1, col=c("red","blue","green"),bty="n", lwd=2)

grid(nx=NA,ny=NULL,lwd=2)
```


#### Average time by year between the most recent clinical evaluation and current date of index year

```{r, label=adclc_fu_int_last, fig=TRUE, width=4.0, height=4.0, echo=FALSE}

enrdt <- enr[enr$ProjName=="ADCLC", c("ID","EnrolledDate","DroppedDate","LostDate","RefusedDate","DeceasedDate")]
# enrdt$ID <- as.numeric(enrdt$ID)
# enrdt <- enrdt[order(c"ID")),]
enrdt$EnrolledDate <- as.Date(enrdt$EnrolledDate)
enrdt$DroppedDate <- as.Date(enrdt$DroppedDate)
enrdt$LostDate <- as.Date(enrdt$LostDate)
enrdt$RefusedDate <- as.Date(enrdt$RefusedDate)
enrdt$DeceasedDate <- as.Date(enrdt$DeceasedDate)

vlist2 <- c("Lost","Refused","No Longer Followed","Deceased","Other")

tmlst  <- data.frame(ID=numeric(),
                          min_time_last=numeric(),
                          year=numeric(),
                          center=character(), 
                          stringsAsFactors=FALSE) 

for (yr in 2001:cur_yr){
  dt = as.Date(paste(yr,cur_mn,cur_dy,sep="-"))
  
  asl00 <- asl1[asl1$VDate < dt & !asl1$VisitType %in% vlist2,c("ID","VDate","VisitType")]
  asl00 <- merge(asl00,enrdt,by="ID",all.x=TRUE)
  
  asl00 <- asl00[!is.na(asl00$EnrolledDate) & asl00$EnrolledDate <= asl00$VDate,]
  asl00 <- asl00[is.na(asl00$DroppedDate) | asl00$DroppedDate > dt,]
  asl00 <- asl00[is.na(asl00$LostDate) | asl00$LostDate > dt,]
  asl00 <- asl00[is.na(asl00$RefusedDate) | asl00$RefusedDate > dt,]
  asl00 <- asl00[is.na(asl00$DeceasedDate) | asl00$DeceasedDate > dt,]
  
  asl00$time_last <- as.numeric((dt - asl00$VDate) / 365.25)
  
  asl002 <- group_by(asl00, ID)
  asl003 <- summarise(asl002,
                      min_time_last = min(time_last))
  
  asl003$year <- yr
  asl003$center <- ifelse(asl003$ID < 50000,"Sacramento","East_Bay")
  
  tmlst <- rbind(tmlst,asl003)
  
}

tmlst1 <- group_by(tmlst, year)
tmlstc <- summarise(tmlst1,
                  mean_time_last = mean(min_time_last))

tmlst1e <- group_by(tmlst[tmlst$center == "East_Bay",], year)
tmlste <- summarise(tmlst1e,
                    mean_time_last = mean(min_time_last))

tmlst1s <- group_by(tmlst[tmlst$center == "Sacramento",], year)
tmlsts <- summarise(tmlst1s,
                    mean_time_last = mean(min_time_last))

plot(mean_time_last ~ year, data=tmlstc, type="n",pch=1, xlim=c(2001,cur_yr), ylim=c(0.5,2.0), xlab="Year", ylab = "Average Time Since Last Evaluation")
lines(mean_time_last ~ year, data=tmlstc, type="l",col="red",lwd=2)
lines(mean_time_last ~ year, data=tmlste, type="l",col="blue",lwd=2)
lines(mean_time_last ~ year, data=tmlsts, type="l",col="green",lwd=2)

legend("topleft",c("ADC Combined","East Bay","Sacramento"), lty=1, col=c("red","blue","green"),bty="n", lwd=2)

grid(nx=NA,ny=NULL,lwd=2)

rm(tmlst1,tmlst1e,tmlst1s)
```

*****

### Loss to Follow-up

#### Loss to follow-up (excluding death) by ethnicity for all enrollees in ADC longitudinal cohort


```{r, label=enr_surv_all_adc, fig=TRUE, echo=FALSE}
# summary(eth.surv)
# summary(eth$time7NLF)
# eth[!is.na(eth$time7NLF) & eth$time7NLF < 0,]

eth.surv <- survfit(Surv(time9NLF,status9) ~ grp, data = eth)
plot(eth.surv,col=col_names, xlab="Time", ylab="% Retained",cex.lab=1.3)
legend(legend=leg2,"bottomleft", col= col_names, lty=1, lwd=1, box.col=0)

grid(nx=NA,ny=NULL,lwd=2)
```

#### Loss to follow-up (excluding death) by ethnicity for Diversity cohort

```{r, label=enr_surv_c2, fig=TRUE, echo=FALSE}

ethc2.surv7 <- survfit(Surv(time9,status9) ~ grp, data = ethc2)
plot(ethc2.surv7,col=col_names, xlab="Time", ylab="% Retained",cex.lab=1.3)
legend(legend=leg2,"bottomleft", col= col_names, lty=1, lwd=1, box.col=0)

grid(nx=NA,ny=NULL,lwd=2)
```

#### Loss to follow-up (excluding death) by ethnicity for community recruits in longitudinal cohort

```{r, label=enr_surv_comm, fig=TRUE, echo=FALSE}

ethc2.surv7 <- survfit(Surv(time9,status9) ~ grp, data = eth[eth$RecrSource %in% "Community",])
plot(ethc2.surv7,col=col_names, xlab="Time", ylab="% Retained",cex.lab=1.3)
legend(legend=leg2,"bottomleft", col= col_names, lty=1, lwd=1, box.col=0)

grid(nx=NA,ny=NULL,lwd=2)
```

*****

#### Loss to follow-up (excluding death) by ethnicity for Diversity cohort, East Bay


```{r, label=enr_surv_c2_eb, fig=TRUE,echo=FALSE}

ethe.surv7 <- survfit(Surv(time9,status9) ~ grp, data = ethe)
plot(ethe.surv7,col=col_names, xlab="Time", ylab="% Retained",cex.lab=1.3)
legend(legend=leg2,"bottomleft", col= col_names, lty=1, lwd=1, box.col=0)

grid(nx=NA,ny=NULL,lwd=2)
```


#### Loss to follow-up (excluding death) by ethnicity for Diversity cohort, Sacramento



```{r,label=enr_surv_c2_s, fig=TRUE,echo=FALSE}

eths.surv7 <- survfit(Surv(time9,status9) ~ grp, data = eths)
plot(eths.surv7,col=col_names, xlab="Time", ylab="% Retained",cex.lab=1.3)
legend(legend=leg2,"bottomleft", col= col_names, lty=1, lwd=1, box.col=0)

grid(nx=NA,ny=NULL,lwd=2)
```

#### Loss to follow-up (excluding death) by education level for all enrollees in ADC longitudinal cohort




```{r,label=enr_surv_educ, fig=TRUE,echo=FALSE}

eth.surv <- survfit(Surv(time9NLF,status9) ~ edgrp, data = eth)
plot(eth.surv,col=col_names, xlab="Time", ylab="% Retained",cex.lab=1.3)
legend(legend=leg4,"bottomleft", col= col_names, lty=1, lwd=1, box.col=0)

grid(nx=NA,ny=NULL,lwd=2)
```

*****

<!--	Loss to follow-up due to death by ethnicity  -->

#### Loss to follow-up due to death by ethnicity for all enrollees in ADC longitudinal cohort


```{r, label=enr_surv_dth_eth, fig=TRUE, echo=FALSE}

eth.surv7d <- survfit(Surv(time9d,status9d) ~ grp, data = eth)
plot(eth.surv7d,col=col_names, xlab="Time", ylab="% Survival",cex.lab=1.3)
legend(legend=leg2,"bottomleft", col= col_names, lty=1, lwd=1, box.col=0)

grid(nx=NA,ny=NULL,lwd=2)
```


<!-- 	Loss to follow-up due to death by initial diagnosis  -->

#### Loss to follow-up due to death by initial clinical diagnosis for all enrollees in ADC longitudinal cohort


```{r,label=enr_surv_dth_dx, fig=TRUE, echo=FALSE}

eth.surv7d <- survfit(Surv(time9d,status9d) ~ synd_ia, data = eth)
plot(eth.surv7d,col=col_names, xlab="Time", ylab="% Survival",cex.lab=1.3)
legend(legend=leg1,"bottomleft", col= col_names, lty=1, lwd=1, box.col=0)

grid(nx=NA,ny=NULL,lwd=2)
```

#### Loss to follow-up due to death by education level for all enrollees in ADC longitudinal cohort


```{r, label=enr_surv_dth_educ, fig=TRUE, echo=FALSE}

eth.surv7d <- survfit(Surv(time9d,status9d) ~ edgrp, data = eth)
plot(eth.surv7d,col=col_names, xlab="Time", ylab="% Survival",cex.lab=1.3)
legend(legend=leg4,"bottomleft", col= col_names, lty=1, lwd=1, box.col=0)

grid(nx=NA,ny=NULL,lwd=2)
```

*****

##  Clinical Diagnosis Conversion

```{r, label=dx_conv_prelim,echo=FALSE, warning=FALSE}

# Create MCI Survival dataset
# colnames(asl1) <- gsub("idal","ID",colnames(asl1))
mcisur <- asl1[asl1$FirstEval %in% "Yes" & asl1$PRIMSYN2 %in% 6, c("ID","VDate","VisitNum","PRIMSYN2")]
colnames(mcisur) <- c("ID","VDate1","VisitNum1","PRIMSYN21")
mcisur$VDate1 <- as.Date(mcisur$VDate1)
mcisur <- merge(mcisur,dcat2,by="ID")

dem <-  asl1[asl1$PRIMSYN2 %in% 5, c("ID","VDate")]
colnames(dem) <- c("ID","demdt")
dem$demdt <- as.Date(dem$demdt, format="%Y-%m-%d")
demmin <- group_by(dem,ID) %>%
  summarise( min_dem_dt = min(demdt))

mcisur <- merge(mcisur,demmin,by="ID",all.x=TRUE)

mcisur$MaxTime <- as.numeric((mcisur$DtLastEval - mcisur$VDate1)/365.25)
mcisur$time_dem <- ifelse(!is.na(mcisur$min_dem_dt),as.numeric((mcisur$min_dem_dt - mcisur$VDate1)/365.25),NA)
mcisur$time2Dem <- ifelse(is.na(mcisur$time_dem),mcisur$MaxTime,mcisur$time_dem)
mcisur$time7Dem <- ifelse(is.na(mcisur$time_dem),ifelse(mcisur$MaxTime>7,7,mcisur$MaxTime),ifelse(mcisur$time_dem>7,7,mcisur$time_dem))

mcisur$status <- ifelse(is.na(mcisur$time_dem),0,1)
mcisur$status7 <- ifelse(is.na(mcisur$time_dem),0,ifelse(mcisur$time_dem>7,0,1))

mcisur$time9Dem <- ifelse(is.na(mcisur$time_dem),ifelse(mcisur$MaxTime>10,10,mcisur$MaxTime),ifelse(mcisur$time_dem>10,10,mcisur$time_dem))
mcisur$status9 <- ifelse(is.na(mcisur$time_dem),0,ifelse(mcisur$time_dem>10,0,1))


# mcisur$CensorDem <- ifelse(is.na(mcisur$time_dem),1,0)
# mcisur$Censor7Dem <- ifelse(is.na(mcisur$time_dem),1,ifelse(mcisur$time_dem>7,1,0))
# 
# mcisur$status <- ifelse(mcisur$CensorDem==0,1,ifelse(mcisur$CensorDem ==1,0,NA))
# mcisur$status7 <- ifelse(mcisur$Censor7Dem==0,1,ifelse(mcisur$Censor7Dem ==1,0,NA))

```


#### Conversion from MCI to dementia by recruitment source for all enrollees in ADC longitudinal cohort


```{r, label=mci_surv_all_adc, fig=TRUE, echo=FALSE, warning=FALSE}
 
mci.surv <- survfit(Surv(time9Dem,status9) ~ RecrSource, data = mcisur)
plot(mci.surv,col=col_names, xlab="Time", ylab="% MCI",cex.lab=1.3)
legend(legend=leg3,"bottomleft", col= col_names, lty=1, lwd=1, box.col=0)


grid(nx=NA,ny=NULL,lwd=2)
```

#### Conversion from MCI to dementia by recruitment source for Diversity cohort (original enrollees)


```{r, label=mci_surv_c2, fig=TRUE, echo=FALSE, warning=FALSE}
c2orig <- as.data.frame(enrstc2t)
c2orig$c2orig <- 1
c2orig$ID <- as.numeric(c2orig$ID)
mcisur <- merge(mcisur,c2orig[,c("ID","c2orig")],by="ID",all.x=TRUE) 
mci.surv2 <- survfit(Surv(time9Dem,status9) ~ RecrSource, data = mcisur[mcisur$c2orig==1,])
plot(mci.surv2,col=col_names, xlab="Time", ylab="% MCI",cex.lab=1.3)
legend(legend=leg3,"bottomleft", col= col_names, lty=1, lwd=1, box.col=0)


grid(nx=NA,ny=NULL,lwd=2)
```

#### Conversion from Normal to MCI by recruitment source for all enrollees in ADC longitudinal cohort


```{r, label=norm_surv_all, fig=TRUE, echo=FALSE, warning=FALSE}

# Create Normal Survival dataset
normsur <- asl1[asl1$FirstEval %in% "Yes" & asl1$PRIMSYN2 %in% c(2,3), c("ID","VDate","VisitNum","PRIMSYN2")]
colnames(normsur) <- c("ID","VDate1","VisitNum1","PRIMSYN21")
normsur$VDate1 <- as.Date(normsur$VDate1)
normsur <- merge(normsur,dcat2,by="ID")

mci <-  asl1[asl1$PRIMSYN2 %in% c(5,6), c("ID","VDate")]
colnames(mci) <- c("ID","mcidt")
mci$mcidt <- as.Date(mci$mcidt, format="%Y-%m-%d")
mcimin <- group_by(mci,ID) %>%
  summarise( min_mci_dt = min(mcidt))

normsur <- merge(normsur,mcimin,by="ID",all.x=TRUE)

normsur$MaxTime <- as.numeric((normsur$DtLastEval - normsur$VDate1)/365.25)
normsur$time_mci <- ifelse(!is.na(normsur$min_mci_dt),as.numeric((normsur$min_mci_dt - normsur$VDate1)/365.25),NA)
normsur$time2MCI <- ifelse(is.na(normsur$time_mci),normsur$MaxTime,normsur$time_mci)
normsur$time7MCI <- ifelse(is.na(normsur$time_mci),ifelse(normsur$MaxTime>7,7,normsur$MaxTime),ifelse(normsur$time_mci>7,7,normsur$time_mci))

normsur$statusn <- ifelse(is.na(normsur$time_mci),0,1)
normsur$status7n <- ifelse(is.na(normsur$time_mci),0,ifelse(normsur$time_mci>7,0,1))

normsur$time9MCI <- ifelse(is.na(normsur$time_mci),ifelse(normsur$MaxTime>10,10,normsur$MaxTime),ifelse(normsur$time_mci>10,10,normsur$time_mci))

normsur$status9n <- ifelse(is.na(normsur$time_mci),0,ifelse(normsur$time_mci>10,0,1))

# normsur$CensorMCI <- ifelse(is.na(normsur$time_mci),1,0)
# normsur$Censor7MCI <- ifelse(is.na(normsur$time_mci),1,ifelse(normsur$time_mci>7,1,0))
# 
# normsur$statusn <- ifelse(normsur$CensorMCI==0,1,ifelse(normsur$CensorMCI ==1,0,NA))
# normsur$status7n <- ifelse(normsur$Censor7MCI==0,1,ifelse(normsur$Censor7MCI ==1,0,NA))

norm.surv <- survfit(Surv(time9MCI,status9n) ~ RecrSource, data = normsur)
plot(norm.surv,col=col_names, xlab="Time", ylab="% Normal",cex.lab=1.3)
legend(legend=leg3,"bottomleft", col= col_names, lty=1, lwd=1, box.col=0)

grid(nx=NA,ny=NULL,lwd=2)
```

#### Conversion from Normal to MCI by recruitment source for Diversity cohort (original enrollees)


```{r, label=norm_surv_c2, fig=TRUE, echo=FALSE, warning=FALSE}
normsur <- merge(normsur,c2orig[,c("ID","c2orig")],by="ID",all.x=TRUE) 

norm.surv2 <- survfit(Surv(time9MCI,status9n) ~ RecrSource, data = normsur[normsur$c2orig==1,])
plot(norm.surv2,col=col_names, xlab="Time", ylab="% Normal",cex.lab=1.3)
legend(legend=leg3,"bottomleft", col= col_names, lty=1, lwd=1, box.col=0)

grid(nx=NA,ny=NULL,lwd=2)
```


*****

## Autopsy Consent and Brain Retrieval Rate

#### Percent of active ADC longitudinal cohort participants with autopsy pre-consent by ethnicity and year

```{r, label=aut_cons_eth_yr, fig=TRUE, echo=FALSE}

#  Autopsy

par(new=FALSE)
plot(enrstaut4$Total_Pct_Aut ~ enrstaut4$year,xlim = c(2001,cur_yr), ylim = c(0,110), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "Year", ylab = "Percent with Autopsy Consent", lty=1, lwd=2.5, col = col_names[1])
par(new=TRUE)
plot(enrstaut4$Afr_Am_Pct_Aut ~ enrstaut4$year,xlim = c(2001,cur_yr), ylim = c(0,110), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "", ylab = "",main="", lty=1, lwd=2.5, col = col_names[2])
par(new= TRUE)
plot(enrstaut4$Hisp_Pct_Aut ~ enrstaut4$year,xlim = c(2001,cur_yr), ylim = c(0,110), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "", ylab = "",main="", lty=1, lwd=2.5, col = col_names[3])
par(new= TRUE)
plot(enrstaut4$White_Pct_Aut ~ enrstaut4$year,xlim = c(2001,cur_yr), ylim = c(0,110), type="l", pch = 39, cex = 1.0, cex.axis=1.2, cex.lab=1.2 ,xlab = "", ylab = "",main="", lty=1, lwd=2.5, col = col_names[4])

legend("bottomright",inset = .00, c('Total','African American','Hispanic','White'), lty = c(1,1,1,1), col=c(col_names[1], col_names[2], col_names[3], col_names[4]),lwd = 2.5,box.col=0,cex=1.0)

```

####  Number of autopsy pre-consents for active longitudinal cohort participants by ethnicity and year

```{r, label=aut_pre_eth_yr,echo=FALSE, results="asis"}
autpre <- enrstaut4[,c("year","African_American.Aut.N","Hispanic.Aut.N","White.Aut.N","Other.Aut.N","Total_Aut")]

rownames(autpre) <- autpre$year
colnames(autpre) <- c("year","African American","Hispanic","White","Other","Total")
autpre <- autpre[, 2:6]

htmlTable(autpre,
          align = "ccccc",
          cgroup=c("Ethnic Group", ""), n.cgroup=c(4,1), 
          rowlabel="Year",
          ctable = TRUE,
          headers = c("African American H", "ispanic W","hite O","ther", "Total"),
          )

```

#### Number and percent of autopsies by grant cycle in enrollees in the ADC longitudinal cohort.

```{r,label="autopsy_rate",echo=FALSE, warning=FALSE, results="asis"}

#	----------------------------------------------------------------------------------------------------
#	Autopsy rate in ADCLC
#	----------------------------------------------------------------------------------------------------


autrt <- enr[enr$ProjName=="ADCLC" & !is.na(enr$EnrolledDate),]
# autrt <- enr[enr$ProjName=="ADCLC" & enr$LatestDesc=="DECEASED"  & !is.na(enr$EnrolledDate),]

# autrt <- enr[enr$ProjName=="ADCLC" & enr$LatestDesc=="DECEASED"  & !is.na(enr$EnrolledDate) & (is.na(enr $RefusedDate) | enr $RefusedDate < enr $EnrolledDate) & (is.na(enr $DroppedDate) | enr $DroppedDate < enr $EnrolledDate) & (is.na(enr $LostDate) | enr $LostDate < enr $EnrolledDate),]

dcat1 <- dcat[,c("ID","Ethnicity", "Autopsy", "DtDeath")]
autrt <- merge(autrt,dcat1,by="ID")

autrt$DtDeath <- as.Date(autrt$DtDeath)
autrt <- autrt[!is.na(autrt$DtDeath),]

autrt$grp <- ifelse(autrt$Ethnicity==1,"Other Ethnicity",
              ifelse(autrt$Ethnicity==2,"Other Ethnicity",
              ifelse(autrt$Ethnicity==3,"Other Ethnicity",
              ifelse(autrt$Ethnicity==4,"African American",
              ifelse(autrt$Ethnicity==5,"Other Ethnicity",
              ifelse(autrt$Ethnicity==6,"Hispanic",
              ifelse(autrt$Ethnicity==7,"White",
              ifelse(autrt$Ethnicity==8,"Other Ethnicity",
              NA))))))))
autrt$grp <- factor(autrt$grp, 
         		labels=c("African American",
                  "Hispanic", 
                  "Other",
                  "White"))


autrt$GrantCycle <- ifelse(autrt$DtDeath < as.Date("2001-07-01"),"1991-2001",ifelse(autrt$DtDeath < as.Date("2006-07-01"),"2001-2006",ifelse(autrt$DtDeath < as.Date("2011-07-01"),"2006-2011",ifelse(autrt$DtDeath < as.Date("2016-07-01"),"2011-2016","2016-2021"))))
autrt$GrantCycle <- factor(autrt$GrantCycle, 
         		labels=c("1991-2001",
                  "2001-2006", 
                  "2006-2011",
                  "2011-2016",
                  "2016-2021"))
autrt$Autopsy <- ifelse(is.na(autrt$Autopsy) | autrt$Autopsy %in% c(-7,9),0, autrt$Autopsy)
autrt$Autopsy <- factor(autrt$Autopsy, 
         		labels=c("No Autopsy",
                  "Autopsy"))
# table(autrt$Autopsy)
table_data_aut <- list()
 
# Get the basic stats
table_data_aut[["1991-2001"]] <- getT1Stat("grp","Autopsy",autrt[!is.na(autrt$grp) & !is.na(autrt$Autopsy) & autrt$GrantCycle=="1991-2001",],hrzl_prop=TRUE)
table_data_aut[["2001-2006"]] <- getT1Stat("grp","Autopsy",autrt[!is.na(autrt$grp) & !is.na(autrt$Autopsy) & autrt$GrantCycle=="2001-2006",],hrzl_prop=TRUE)
table_data_aut[["2006-2011"]] <- getT1Stat("grp","Autopsy",autrt[!is.na(autrt$grp) & !is.na(autrt$Autopsy) & autrt$GrantCycle=="2006-2011",],hrzl_prop=TRUE)
table_data_aut[["2011-2016"]] <- getT1Stat("grp","Autopsy",autrt[!is.na(autrt$grp) & !is.na(autrt$Autopsy) & autrt$GrantCycle=="2011-2016",],hrzl_prop=TRUE)
table_data_aut[["2016-2021"]] <- getT1Stat("grp","Autopsy",autrt[!is.na(autrt$grp) & !is.na(autrt$Autopsy) & autrt$GrantCycle=="2016-2021",],hrzl_prop=TRUE)




out_data_aut <- descStatTable(table_data_aut)
out_data_aut$output_data <- out_data_aut$output_data[,c(2:ncol(out_data_aut$output_data),1)]

# latex(out_data_aut$output_data,
#           rgroup=out_data_aut$rgroup, n.rgroup=out_data_aut$n.rgroup, 
#         file="", title="",caption="Autopsies obtained for individuals enrolled in ADC longitudinal cohort by grant cycle.",
#         label="adclc_aut_rt",booktabs=TRUE, where="!htbp")   


# generate html code for table
htmlTable(out_data_aut$output_data, align="rrrr",
          rgroup=out_data_aut$rgroup, n.rgroup=out_data_aut$n.rgroup, 
          # rgroupCSSseparator="", 
          rowlabel="", 
          caption="Autopsies obtained for individuals enrolled in ADC longitudinal cohort by grant cycle.", 
          # tfoot="<sup>a</sup> Also known as Breslow thickness", 
          ctable=TRUE)

```

*****

## Clinical-Pathological Correlation



```{r, label=pth_dx_prelim, echo=FALSE}


dcat$ClinDxPres <- ifelse(!is.na(dcat$ClinDxMRA) | dcat$SYNDRMRA==2 | dcat$SYNDRMRA==3 | dcat$SYNDRMRA==6,1,2)
dcat$ClinDxPres <- 
  factor(dcat$ClinDxPres, 
         labels=c("All Clin Dx",
                  NA))

n_lbd_cvd <- nrow(dcat[!is.na(dcat$PathDx) & dcat$PathDx=="LBD+CVD",])
n_oth <- nrow(dcat[!is.na(dcat$PathDx) & dcat$PathDx=="Other",])
n_oth_syn <- nrow(dcat[!is.na(dcat$PathDx) & !dcat$SYNDRMRA %in% c(2,3,5,6),])


```


#### Correspondence of the final clinical diagnosis with neuropathology diagnosis.


```{r, label="clin_path",echo=FALSE, warning=FALSE, results="asis"}

#	----------------------------------------------------------------------------------------------------
#	Clinical-Pathological Correlation
#	----------------------------------------------------------------------------------------------------



table_data_cp <- list()
 
# Get the basic stats
table_data_cp[["1991-2006"]] <- getT1Stat("ClinDxMRA2","PathDx",dcat[!dcat$PathDx %in% c("Other","LBD+CVD") & !is.na(dcat$DtDeath) & dcat$DtDeath >= as.Date("1991-10-01") & dcat$DtDeath < as.Date("2006-07-01"),],hrzl_prop=TRUE)
table_data_cp[["1991-2006 Total"]] <- getT1Stat("ClinDxPres","PathDx",dcat[!dcat$PathDx %in% c("Other","LBD+CVD") & !is.na(dcat$DtDeath) & dcat$DtDeath >= as.Date("1991-10-01") & dcat$DtDeath < as.Date("2006-07-01"),],hrzl_prop=TRUE)
table_data_cp[["2006-2016"]] <- getT1Stat("ClinDxMRA2","PathDx",dcat[!dcat$PathDx %in% c("Other","LBD+CVD") & !is.na(dcat$DtDeath) & dcat$DtDeath >= as.Date("2006-07-01") & dcat$DtDeath < as.Date("2016-07-01"),],hrzl_prop=TRUE)
table_data_cp[["2006-2016 Total"]] <- getT1Stat("ClinDxPres","PathDx",dcat[!dcat$PathDx %in% c("Other","LBD+CVD") & !is.na(dcat$DtDeath) & dcat$DtDeath >= as.Date("2006-07-01") & dcat$DtDeath < as.Date("2016-07-01"),],hrzl_prop=TRUE)
table_data_cp[["1991-2016 Total"]] <- getT1Stat("ClinDxPres","PathDx",dcat[!dcat$PathDx %in% c("Other","LBD+CVD") & !is.na(dcat$DtDeath) & dcat$DtDeath >= as.Date("1991-10-01") & dcat$DtDeath < as.Date("2016-07-01"),],hrzl_prop=TRUE)

cnm <- colnames(table_data_cp[[1]])

out_data_cp <- descStatTable(table_data_cp)
out_data_cp$output_data <- out_data_cp$output_data[,c(2:ncol(out_data_cp$output_data),1)]

# Add a column spanner for the Neuropthology diagnosis columns
cgroup <- c("Neuropathology Dx","")
n.cgroup <- c(8,1)

# latex(out_data_cp$output_data,
#           rgroup=out_data_cp$rgroup, n.rgroup=out_data_cp$n.rgroup, 
#         file="", title="Clinical Dx",caption="Clinical-pathological correlation.",
#         label="clin_path_dem",booktabs=TRUE, where="!htbp",cgroup=cgroup,n.cgroup=n.cgroup)   

# generate html code for table
htmlTable(out_data_cp$output_data, align="rrrrrrrrr",
          rgroup=out_data_cp$rgroup, n.rgroup=out_data_cp$n.rgroup, 
          # rgroupCSSseparator="", 
          cgroup = cgroup,
          n.cgroup = n.cgroup,
          rowlabel="", 
          caption=paste("Clinical-pathological correlation. This table does not include ",n_lbd_cvd," cases with mixed Lewy body and cerebrovascular disease and ",n_oth," cases with other pathologies.", sep=""), 
          # tfoot="<sup>a</sup> Also known as Breslow thickness", 
          ctable=TRUE)

        
```



#### Correspondence of the final clinical diagnosis with neuropathology diagnosis. African Americans and Hispanics


```{r, label="clin_path_minority",echo=FALSE, warning=FALSE, results="asis"}

#  ----------------------------------------------------------------------------------------------------
#  Clinical-Pathological Correlation
#  ----------------------------------------------------------------------------------------------------



n_lbd_cvd <- nrow(dcat[!is.na(dcat$PathDx) & dcat$PathDx=="LBD+CVD" & dcat$Ethnicity %in% c(4,6),])
n_oth <- nrow(dcat[!is.na(dcat$PathDx) & dcat$PathDx=="Other" & dcat$Ethnicity %in% c(4,6),])
n_oth_syn <- nrow(dcat[!is.na(dcat$PathDx) & !dcat$SYNDRMRA %in% c(2,3,5,6) & dcat$Ethnicity %in% c(4,6),])


table_data_cp <- list()
 
# Get the basic stats
table_data_cp[["1991-2006"]] <- getT1Stat("ClinDxMRA2","PathDx",dcat[!dcat$PathDx %in% c("Other","LBD+CVD") & !is.na(dcat$DtDeath) & dcat$DtDeath >= as.Date("1991-10-01") & dcat$DtDeath < as.Date("2006-07-01") & dcat$Ethnicity %in% c(4,6),],hrzl_prop=TRUE)
table_data_cp[["1991-2006 Total"]] <- getT1Stat("ClinDxPres","PathDx",dcat[!dcat$PathDx %in% c("Other","LBD+CVD") & !is.na(dcat$DtDeath) & dcat$DtDeath >= as.Date("1991-10-01") & dcat$DtDeath < as.Date("2006-07-01") & dcat$Ethnicity %in% c(4,6),],hrzl_prop=TRUE)
table_data_cp[["2006-2016"]] <- getT1Stat("ClinDxMRA2","PathDx",dcat[!dcat$PathDx %in% c("Other","LBD+CVD") & !is.na(dcat$DtDeath) & dcat$DtDeath >= as.Date("2006-07-01") & dcat$DtDeath < as.Date("2016-07-01") & dcat$Ethnicity %in% c(4,6),],hrzl_prop=TRUE)
table_data_cp[["2006-2016 Total"]] <- getT1Stat("ClinDxPres","PathDx",dcat[!dcat$PathDx %in% c("Other","LBD+CVD") & !is.na(dcat$DtDeath) & dcat$DtDeath >= as.Date("2006-07-01") & dcat$DtDeath < as.Date("2016-07-01") & dcat$Ethnicity %in% c(4,6),],hrzl_prop=TRUE)
table_data_cp[["1991-2016 Total"]] <- getT1Stat("ClinDxPres","PathDx",dcat[!dcat$PathDx %in% c("Other","LBD+CVD") & !is.na(dcat$DtDeath) & dcat$DtDeath >= as.Date("1991-10-01") & dcat$DtDeath < as.Date("2016-07-01") & dcat$Ethnicity %in% c(4,6),],hrzl_prop=TRUE)

table_data_cp <- tableBalance(table_data_cp)

out_data_cp <- descStatTable(table_data_cp)
out_data_cp$output_data <- out_data_cp$output_data[,c(2:ncol(out_data_cp$output_data),1)]

# Add a column spanner for the Neuropthology diagnosis columns
cgroup <- c("Neuropathology Dx","")
n.cgroup <- c(8,1)

# latex(out_data_cp$output_data,
#           rgroup=out_data_cp$rgroup, n.rgroup=out_data_cp$n.rgroup, 
#         file="", title="Clinical Dx",caption="Clinical-pathological correlation.",
#         label="clin_path_dem",booktabs=TRUE, where="!htbp",cgroup=cgroup,n.cgroup=n.cgroup)   

# generate html code for table
htmlTable(out_data_cp$output_data, align="rrrrrrrrr",
          rgroup=out_data_cp$rgroup, n.rgroup=out_data_cp$n.rgroup, 
          # rgroupCSSseparator="", 
          cgroup = cgroup,
          n.cgroup = n.cgroup,
          rowlabel="", 
          caption=paste("Clinical-pathological correlation. This table does not include ",n_lbd_cvd," cases with mixed Lewy body and cerebrovascular disease and ",n_oth," cases with other pathologies.", sep=""), 
#           tfoot="<sup>a</sup> At most recent clinical assessment", 
          ctable=TRUE)

        
```

